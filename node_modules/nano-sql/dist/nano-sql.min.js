!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var i in n)("object"==typeof exports?exports:t)[i]=n[i]}}(window,function(){return n={},t.m=e=[function(t,e,n){(function(t){Object.defineProperty(e,"e",{value:!0});var i=n(4),r=n(5);n(1).Promise.doPolyFill(),e.stopWords=["a","about","after","all","also","am","an","and","andor","another","any","are","as","at","be","because","been","before","being","between","both","but","by","came","can","come","could","did","do","each","for","from","get","got","had","has","have","he","her","here","him","himself","his","how","i","if","in","into","is","it","like","make","many","me","might","more","most","much","must","my","never","now","of","on","only","or","other","our","out","over","said","same","see","should","since","some","still","such","take","than","that","the","their","them","then","there","these","they","this","those","through","to","too","under","up","very","was","way","we","well","were","what","where","which","while","who","with","would","you","your"],e.u=function(t){return t?JSON.parse(JSON.stringify(t)):null},e.splitArr=function(t,e){for(var n=t.length%e,i=n,r=Math.floor(t.length/e),o=[],s=0;s<t.length;s+=r){var a=r+s,u=!1;0!=n&&i&&(a++,i--,u=!0),o.push(t.slice(s,a)),u&&s++}return o},e.fastCHAIN=function(t,n){return new Promise(function(i,r){if(t&&t.length){var o=[],s=!1,a=function(){if(o.length<t.length)n(t[o.length],o.length,function(t){o.push(t),o.length%100==0?e.setFast(a):a()},function(t){s=!0,r(t)});else{if(s)return;i(o)}};a()}else i([])})},e.fastRACE=function(t,e){return new Promise(function(n,i){if(t&&t.length){var r=!1,o=0,s=function(){o<t.length&&(e(t[o],o,function(t){r||(r=!0,n([t]))},function(t){r||(r=!0,i(t))}),o++,s())};s()}else n([])})},e.fastALL=function(t,e){return Promise.all((t||[]).map(function(t,n){return new Promise(function(i,r){e(t,n,i,r)})}))};var o="undefined"==typeof window?"":navigator.userAgent||"";e.isSafari=0!==o.length&&(/^((?!chrome|android).)*safari/i.test(o)||/iPad|iPhone|iPod/.test(o)&&!window.MSStream),e.isMSBrowser=0!==o.length&&(0<o.indexOf("MSIE ")||0<o.indexOf("Trident/")||0<o.indexOf("Edge/")),e.isAndroid=/Android/.test(o),e.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return void 0!==t&&t.f.randomBytes?t.f.randomBytes(2).reduce(function(t,e){return e*t}):Math.round(Math.random()*Math.pow(2,16))},e.tokenizer=function(t,n,o,s,a){function u(t){return!t||1===String(t).length||-1!==e.stopWords.indexOf(t)}var c=(s||"").toLowerCase().replace(/(\d+)\/(\d+)|(?:\d+(?:,\d+)*|\d+)(?:\.\d+)?/gim,function(t,e,n){return e||n?(parseInt(e)/parseInt(n)).toFixed(a||4):parseFloat(t.replace(/\,/gim,"")).toFixed(a||4)}).replace(/\-|\_|\[|\]|\(|\)|\{|\}|\r?\n|\r|\t/gim," ").replace(/[^\w\s]|(\d\.)/gim,"$1").replace(/\s+/g," ").split(" ");switch(o[1]){case"english":return c.map(function(t,e){return{i:e,o:t,w:isNaN(t)?u(t)?"":i(r(t)):t}});case"english-stem":return c.map(function(t,e){return{i:e,o:t,w:isNaN(t)?u(t)?"":r(t):t}});case"english-meta":return c.map(function(t,e){return{i:e,o:t,w:isNaN(t)?u(t)?"":i(t):t}})}return c.map(function(t,e){return{o:t,w:t,i:e}})},e.timeid=function(t){for(var n=Math.round((new Date).getTime()/(t?1:1e3)).toString();n.length<(t?13:10);)n="0"+n;return n+"-"+(e.random16Bits()+e.random16Bits()).toString(16)},e.intersect=function(t,e){return!(!t||!e)&&!(!t.length||!e.length)&&0<(t||[]).filter(function(t){return-1!==(e||[]).indexOf(t)}).length},e.uuid=function(){var t,n,i="";return[i,i,i,i,i,i,i,i].reduce(function(r,o,s){for(t=e.random16Bits(),n=3===s?4:4===s?(t%16&3|8).toString(16):i,t=t.toString(16);t.length<4;)t="0"+t;return r+(-1<[2,3,4,5].indexOf(s)?"-":i)+(n+t).slice(0,4)},i)},e.hash=function(t){for(var e=5381,n=t.length;n;)e=33*e^t.charCodeAt(--n);return(e>>>0).toString(16)};var s={int:function(t){return t},uuid:e.uuid,timeId:function(){return e.timeid()},timeIdms:function(){return e.timeid(!0)}};e.generateID=function(t,e){return s[t]?s[t](e||1):""},e.cleanArgs=function(t,n){for(var i={},r=t.length;r--;){var o=t[r].split(":");1<o.length?i[o[0]]=e.cast(o[1],n[o[0]]||void 0):i[o[0]]=n[o[0]]||void 0}return i},e.isObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},e.cast=function(t,n){if("any"===t||"blob"===t)return n;var i=typeof n;if("undefined"==i||null===n)return n;var r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},o=function(t,n){switch(t){case"safestr":return o("string",n).replace(/[&<>"'`=\/]/gim,function(t){return r[t]});case"int":return"number"!=i||n%1!=0?parseInt(n||0):n;case"number":case"float":return"number"!=i?parseFloat(n||0):n;case"any[]":case"array":return Array.isArray(n)?n:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!=i?String(n):n;case"object":case"obj":case"map":return e.isObject(n)?n:{};case"boolean":case"bool":return!0===n}return n},s=o(String(t||"").toLowerCase(),n);if(-1===t.indexOf("[]"))return void 0!==s?-1<["int","float","number"].indexOf(t)&&isNaN(s)?0:s:void 0;var a=t.slice(0,t.lastIndexOf("[]"));return(n||[]).map(function(t){return e.cast(a,t)})},e.binarySearch=function(t,n,i,r){var o=i||0,s=r||t.length;if(t[o]>n)return o;if(t[s]<n)return s+1;var a=Math.floor((o+s)/2);return n===t[a]?a:s-1===o?s:n>t[a]?e.binarySearch(t,n,a,s):n<t[a]?e.binarySearch(t,n,o,a):s},e.resolvePath=function(t){if(!t)return[];if(c[t])return c[t].slice();var e=-1!==t.indexOf("[")?t.split(/\.|\[/gim).map(function(t){return t.replace(/\]/gim,"")}):t.split(".");return c[t]=e,c[t].slice()},e.noop=function(){};var a=(u.prototype.a=function(){var t=this;if(!this.h){if(this.v&&!this.b.length)return this.h=!0,void(this.onComplete&&this.onComplete());if(this.b.length){function n(){t.y++,t.y%100==0?e.setFast(t.a):t.a()}var i=this.b.shift()||[];i[1]?i[1](i[0],n,this.onError?this.onError:e.noop):this.processItem&&this.processItem(i[0],this.y,n,this.onError?this.onError:e.noop)}else this._=!1}},u.prototype.finished=function(){this.v=!0,this.h||this._||this.b.length||(this.h=!0,this.onComplete&&this.onComplete())},u.prototype.newItem=function(t,e){this.b.push([t,e]),this._||(this._=!0,this.a())},u);function u(t,e,n){this.processItem=t,this.onError=e,this.onComplete=n,this.b=[],this._=!1,this.v=!1,this.y=0,this.h=!1,this.a=this.a.bind(this)}e.g=a,e.deepGet=function(t,n){var i=function(t,e,n){return t[e]&&n?i(t,e+1,n[t[e]]):n};return i(Array.isArray(t)?t:e.resolvePath(t),0,n)},e.deepFreeze=function(t){return Object.getOwnPropertyNames(t||{}).forEach(function(n){var i=t[n];"object"==typeof i&&null!==i&&(t[n]=e.deepFreeze(i))}),Object.freeze(t)},e.crowDistance=function(t,e,n,i,r){function o(t){return t*(Math.PI/180)}void 0===r&&(r=6371);var s=o(n-t),a=o(i-e),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(o(t))*Math.cos(o(n))*Math.sin(a/2)*Math.sin(a/2);return r*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))};var c={};function f(t){return t[0].apply(null,p.call(t,1))}e.objQuery=function(t,e,n){var i=function(t,e,n){return t[e]&&n?i(t,e+1,n[t[e]]):n},r=t+(n?"1":"0");if(c[r])return i(c[r],0,e);var o=[];if(o=-1<t.indexOf("[")?[].concat.apply([],t.split(".").map(function(t){return t.match(/([^\[]+)|\[([^\]]+)\]\[/gim)||t})).map(function(t){return t.replace(/\[|\]/gim,"")}):t.split("."),n){var s=o.shift()+"."+o.shift();o.unshift(s)}return c[r]=o,i(c[r],0,e)};var h=0,l={},p=Array.prototype.slice,d="setMsg",y="undefined"!=typeof window&&window.postMessage&&window.addEventListener;y&&window.addEventListener("message",function(t){var e,n=t.data;"string"==typeof n&&0===n.indexOf(d)&&(e=l[n])&&(delete l[n],f(e))}),e.setFast=y?function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=h++,i=d+n;return l[i]=t,window.postMessage(i,"*"),n}:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];setTimeout(function(){f(t)},0)}}).call(this,n(2))},function(t,e,n){"use strict";(function(t){function n(t){return t[0].apply(null,o.call(t,1))}Object.defineProperty(e,"e",{value:!0});var i=0,r={},o=Array.prototype.slice,s="undefined"!=typeof window&&window.postMessage&&window.addEventListener;function a(){}s&&window.addEventListener("message",function(t){var e,i=t.data;"string"==typeof i&&0===i.indexOf("setMsg")&&(e=r[i])&&(delete r[i],n(e))}),e.setFast=s?function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=i++,o="setMsg"+n;return r[o]=t,window.postMessage(o,"*"),n}:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];setTimeout(function(){n(t)},0)};var u=["R"],c=["F"],f=["P"],h=(l.doPolyFill=function(){void 0!==t&&(t.Promise||(t.Promise=this)),"undefined"!=typeof window&&(window.Promise||(window.Promise=this))},l.prototype.catch=function(t){return this.then(function(){},t)},l.prototype.then=function(t,e){if("function"!=typeof t&&this.O===c||"function"!=typeof e&&this.O===u)return this;var n=new l(a);return this.O!==f?y(n,this.O===c?t:e,this.S):this.j.push(new p(n,t,e)),n},l.resolve=function(t){return t instanceof this?t:v.k(new l(a),t)},l.reject=function(t){return v.N(new l(a),t)},l.all=function(t){return new l(function(e,n){var i=[];if(t.length)for(var r=function(n,r,o){void 0!==o?i.push(o):i.push(r),i.length==t.length&&e(i)},o=0;o<t.length;o++)t[o].then(function(t){r(0,t,void 0)}).catch(function(t){r(0,void 0,t)});else e([])})},l.race=function(t){var e,n=t.length,i=!1,r=-1,o=new l(a);if(!1!==Array.isArray(t))return this.reject(new TypeError);if(!n)return this.resolve([]);for(;++r<n;)e=t[r],this.resolve(e).then(function(t){i||(i=!0,v.k(o,t))},function(t){i||(i=!0,v.N(o,t))});return o},l);function l(t){this.O=f,this.j=[],this.S=void 0,t!==a&&m(this,t)}e.Promise=h;var p=(d.prototype.T=function(t){v.k(this.I,t)},d.prototype.A=function(t){y(this.I,this.M,t)},d.prototype.x=function(t){v.N(this.I,t)},d.prototype.R=function(t){y(this.I,this.L,t)},d);function d(t,e,n){this.I=t,"function"==typeof e&&(this.M=e,this.T=this.A),"function"==typeof n&&(this.L=n,this.x=this.R)}function y(t,n,i){e.setFast(function(){var e;try{e=n.apply(null,i)}catch(e){return v.N(t,e)}return e===t?v.N(t,new TypeError):v.k(t,e),null})}e.P=p;var v=(b.k=function(t,e){var n=w(g,e),i=n.D,r=-1,o=t.j.length;if("error"===n.C)return b.N(t,n.D);if(i)m(t,i);else for(t.O=c,t.S=e;++r<o;)t.j[r].T(e);return t},b.N=function(t,e){t.O=u,t.S=e;for(var n=-1,i=t.j.length;++n<i;)t.j[n].x(e);return t},b);function b(){}function g(t){var e=t&&t.then;return!t||"object"!=typeof t&&"function"!=typeof t||"function"!=typeof e?null:function(){e.apply(t,arguments)}}function m(t,e){var n=!1;function i(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];n||(n=!0,v.N(t,e))}function r(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];n||(n=!0,v.k(t,e))}var o=w(function(){e(r,i)});"error"===o.C&&i(o.D)}function w(t,e){var n={C:null,D:null};try{n.D=t(e),n.C="success"}catch(t){n.C="error",n.D=t}return n}}).call(this,n(2))},function(t,e){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e,n){Object.defineProperty(e,"e",{value:!0});var i=n(0),r=(o.prototype.clone=function(t){this.F&&!t&&this.F(this.J,"drop",null);var e=new o;return e.doAI=this.doAI,e.ai=this.ai,e.sortIndex=this.sortIndex,e.F=this.F,e.J=this.J,e.pkType=this.pkType,t&&this.set([]),e},o.prototype.onChange=function(t,e){this.J=t,this.F=e},o.prototype.set=function(t){var e=this;this.Q=t||[],this.H={},this.Q.forEach(function(t,n){e.H[String(t)]=!0}),this.doAI&&this.Q.length&&(this.ai=this.Q[this.Q.length-1]+1)},o.prototype.getLocation=function(t,e){var n=this.indexOf(t);return-1!==n?n:this.sortIndex?i.binarySearch(this.Q,t,e):i.binarySearch(this.Q.sort(function(t,e){return e<t?1:-1}),t,e)},o.prototype.add=function(t,e){if(!this.H[String(t)])if(this.F&&!e&&this.F(this.J,"add",t),this.H[String(t)]=!0,e&&-1!==["number","int","float"].indexOf(this.pkType)&&(t=parseFloat(t)),this.doAI)this.ai++,this.Q.push(t);else if(this.sortIndex){var n=i.binarySearch(this.Q,t);this.Q.splice(n,0,t)}else this.Q.push(t)},o.prototype.keys=function(){return this.Q},o.prototype.exists=function(t){return!!this.H[String(t)]},o.prototype.indexOf=function(t){return this.H[String(t)]?this.sortIndex?i.binarySearch(this.Q,t):this.Q.indexOf(t):-1},o.prototype.remove=function(t,e){if(this.F&&!e&&this.F(this.J,"rm",t),e&&-1!==["number","int","float"].indexOf(this.pkType)&&(t=parseFloat(t)),this.H[String(t)]){var n=this.indexOf(t);this.H[String(t)]=!1,this.Q.splice(n,1)}},o);function o(){this.Q=[],this.H={},this.ai=1,this.sortIndex=!0,this.doAI=!1}e.DatabaseIndex=r,e.syncPeerIndex=function(t,e){t.peerMode&&(Object.keys(e).forEach(function(n){e[n].onChange(n,function(e,n,r){t.peers.filter(function(e){return e!==t.pid}).forEach(function(t){localStorage.setItem(t+"::"+i.random16Bits().toString(16),n+","+e+","+(r||""))})})}),window.addEventListener("storage",function(n){if(n.key&&-1!==n.key.indexOf(t.pid+"::")){var i=(n.newValue||"").split(",");switch(localStorage.removeItem(n.key),i[0]){case"rm":e[i[1]].remove(i[2],!0);break;case"add":e[i[1]].add(i[2],!0);break;case"drop":e[i[1]].clone(!0)}}}))}},function(t,e,n){"use strict";t.exports=function(t){var e,n,f,h,l="",p=0;function d(t){l+=t}function y(e){return t.charAt(p+e).toUpperCase()}function v(t){return function(){return y(t)}}if(!(t=String(t||"")))return"";for(n=v(1),f=v(0),h=v(-1);!c(f());){if(!f())return"";p++}switch(f()){case"A":"E"===n()?(d("E"),p+=2):(d("A"),p++);break;case"G":case"K":case"P":"N"===n()&&(d("N"),p+=2);break;case"W":"R"===n()?(d(n()),p+=2):"H"===n()?(d(f()),p+=2):a(n())&&(d("W"),p+=2);break;case"X":d("S"),p++;break;case"E":case"I":case"O":case"U":d(f()),p++}for(;f();)if(e=1,!c(f())||f()===h()&&"C"!==f())p+=e;else{switch(f()){case"B":"M"!==h()&&d("B");break;case"C":s(n())?"I"===n()&&"A"===y(2)?d(i):"S"!==h()&&d("S"):"H"===n()?(d(i),e++):d("K");break;case"D":"G"===n()&&s(y(2))?(d("J"),e++):d("T");break;case"G":"H"===n()?o(y(-3))||"H"===y(-4)||(d("F"),e++):"N"===n()?!c(y(2))||"E"===y(2)&&"D"===y(3)||d("K"):s(n())&&"G"!==h()?d("J"):d("K");break;case"H":a(n())&&!u(h())&&d("H");break;case"K":"C"!==h()&&d("K");break;case"P":"H"===n()?d("F"):d("P");break;case"Q":d("K");break;case"S":"I"!==n()||"O"!==y(2)&&"A"!==y(2)?"H"===n()?(d(i),e++):d("S"):d(i);break;case"T":"I"!==n()||"O"!==y(2)&&"A"!==y(2)?"H"===n()?(d(r),e++):"C"===n()&&"H"===y(2)||d("T"):d(i);break;case"V":d("F");break;case"W":a(n())&&d("W");break;case"X":d("KS");break;case"Y":a(n())&&d("Y");break;case"Z":d("S");break;case"F":case"J":case"L":case"M":case"N":case"R":d(f())}p+=e}return l};var i="X",r="0";function o(t){return"B"===(t=f(t))||"D"===t||"H"===t}function s(t){return"E"===(t=f(t))||"I"===t||"Y"===t}function a(t){return"A"===(t=f(t))||"E"===t||"I"===t||"O"===t||"U"===t}function u(t){return"C"===(t=f(t))||"G"===t||"P"===t||"S"===t||"T"===t}function c(t){var e=function(t){return f(t).charCodeAt(0)}(t);return 65<=e&&e<=90}function f(t){return String(t).charAt(0).toUpperCase()}},function(t,e,n){"use strict";t.exports=function(t){var e,n;return(t=String(t).toLowerCase()).length<3?t:(121===t.charCodeAt(0)&&(e=!0,t="Y"+t.substr(1)),E.test(t)?t=t.substr(0,t.length-2):w.test(t)&&(t=t.substr(0,t.length-1)),(n=m.exec(t))?u.test(n[1])&&(t=t.substr(0,t.length-1)):(n=b.exec(t))&&h.test(n[1])&&(t=n[1],g.test(t)?t+="e":A.test(t)?t=t.substr(0,t.length-1):l.test(t)&&(t+="e")),(n=y.exec(t))&&h.test(n[1])&&(t=n[1]+"i"),(n=O.exec(t))&&u.test(n[1])&&(t=n[1]+i[n[2]]),(n=x.exec(t))&&u.test(n[1])&&(t=n[1]+r[n[2]]),(n=k.exec(t))?f.test(n[1])&&(t=n[1]):(n=v.exec(t))&&f.test(n[1])&&(t=n[1]),(n=d.exec(t))&&(f.test(n[1])||c.test(n[1])&&!l.test(n[1]))&&(t=n[1]),p.test(t)&&f.test(t)&&(t=t.substr(0,t.length-1)),e&&(t="y"+t.substr(1)),t)};var i={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},r={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},o="[aeiouy]",s="([^aeiou][^aeiouy]*)",a="("+o+"[aeiou]*)",u=new RegExp("^"+s+"?"+a+s),c=new RegExp("^"+s+"?"+a+s+a+"?$"),f=new RegExp("^"+s+"?("+a+s+"){2,}"),h=new RegExp("^"+s+"?"+o),l=new RegExp("^"+s+o+"[^aeiouwxy]$"),p=/ll$/,d=/^(.+?)e$/,y=/^(.+?)y$/,v=/^(.+?(s|t))(ion)$/,b=/^(.+?)(ed|ing)$/,g=/(at|bl|iz)$/,m=/^(.+?)eed$/,w=/^.+?[^s]s$/,E=/^.+?(ss|i)es$/,A=/([^aeiouylsz])\1$/,O=new RegExp("^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$"),x=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,k=new RegExp("^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$")},function(t,e,n){var i=this&&this.W||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};Object.defineProperty(e,"e",{value:!0});var r=n(1),o=n(12),s=n(13),a=n(14),u=n(0),c=n(15),f=n(23),h=n(10),l=n(24),p=["_util","_ttl"],d=(y.prototype.rowFilter=function(t){return this.rowFilters[this.sTable]=t,this},y.prototype.toColumn=function(t){return this.toColFns[this.sTable]||(this.toColFns[this.sTable]={}),this.toColFns[this.sTable]=t,this},y.prototype.toRow=function(t){return this.toRowFns[this.sTable]||(this.toRowFns[this.sTable]={}),this.toRowFns[this.sTable]=t,this},y.prototype.fastRand=function(){return this.$++,this.$>=this.z.length&&(this.$=0),this.z[this.$]},y.prototype.clearTTL=function(t){var e=this.sTable+"."+t;return this.query("delete").where(["key","=",e]).manualExec({table:"_ttl"})},y.prototype.expires=function(t){var e=this;return new Promise(function(n,i){var r=e.sTable+"."+t;e.query("select").where(["key","=",r]).manualExec({table:"_ttl"}).then(function(t){t.length?n({time:(t[0].date-Date.now())/1e3,cols:t[0].cols}):n({time:-1,cols:[]})})})},y.prototype.K=function(){var t=this;this.B&&clearTimeout(this.B);var e=0,n=0,i=function(){t.query("select").range(20,20*e).manualExec({table:"_ttl"}).then(function(r){r.length?u.fastCHAIN(r,function(e,i,r){if(e.date<Date.now()){function o(){t.query("delete").where(["key","=",e.key]).manualExec({table:"_ttl"}).then(r)}var s=e.key.split("."),a=s[0],u=-1===["float","int","number"].indexOf(t.U[a])?s[1]:parseFloat(s[1]);if(e.cols.length){var c={};e.cols.forEach(function(t){c[t]=null}),t.query("upsert",c).where([t.V[a],"=",u]).manualExec({table:a}).then(o)}else t.query("delete").where([t.V[a],"=",u]).manualExec({table:a}).then(o)}else n=Math.max(n,e.date),r()}).then(function(){e++,i()}):n&&(t.B=setTimeout(t.K,n-Date.now()))})};i()},y.prototype.table=function(t){return t&&(this.sTable=t),this},y.prototype.getPeers=function(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.id)||"[]")},y.prototype.connect=function(){var t=this,n=this;return new Promise(function(o,s){var a={models:n.dataModels,actions:n.G,views:n.X,config:n.Y,parent:t};a.models[p[0]]=[{key:"key",type:"string",props:["pk()","ai()"]},{key:"value",type:"any"}],a.models[p[1]]=[{key:"key",type:"string",props:["pk()"]},{key:"table",type:"string"},{key:"cols",type:"string[]"},{key:"date",type:"number"}],n.Y&&n.Y.history&&t.use(new f.Z(n.Y.historyMode)),n.Y&&!1===n.Y.mode||t.use(new c.NanoSQLDefaultBackend),"undefined"!=typeof window&&t.Y&&t.Y.peer&&(t.peerMode=!0),u.fastCHAIN(n.plugins,function(t,e,n){t.willConnect?t.willConnect(a,function(t){a=t,n()}):n()}).then(function(){function c(){u.fastALL(n.plugins,function(e,n,i){e.getId&&!t.id&&(t.id=e.getId()),e.didConnect?e.didConnect(a,function(){i()}):i()}).then(function(){if(t.peerMode){var s=0;t.id||(t.id=t.pid),t.peers=t.getPeers(),t.peers.unshift(t.pid),localStorage.setItem("nsql-peers-"+t.id,JSON.stringify(t.peers)),window.addEventListener("storage",function(e){if(e.key==="nsql-peers-"+t.id&&(t.peers=t.getPeers()),e.key&&0===e.key.indexOf(t.pid+".")){localStorage.removeItem(e.key);var n=JSON.parse(e.newValue||"{}");t.peerEvents.push(n.query.queryID||""),t.triggerEvent(i({},n,{types:["peer-change"]})),r.setFast(function(){t.triggerEvent(n)})}if(50<++s&&t.peers[0]===t.pid){s=0;for(var o=localStorage.length,a={};o--;){var u=localStorage.key(o),c=u?u.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(u&&c){var f=(c||[""])[0];a[f]||(a[f]=[]),a[f].push(u)}}Object.keys(a).forEach(function(e){10<a[e].length&&(t.peers=t.peers.filter(function(t){return t!==e}),a[e].forEach(function(t){localStorage.removeItem(t)}),localStorage.setItem("nsql-peers-"+t.id,JSON.stringify(t.peers)))})}}),window.onblur=function(){t.focused=!1},window.onfocus=function(){t.peers=t.peers.filter(function(e){return e!==t.pid}),t.peers.unshift(t.pid),localStorage.setItem("nsql-peers-"+t.id,JSON.stringify(t.peers)),t.focused=!0},e.nSQL("*").on("change",function(e){var n=t.peerEvents.indexOf(e.query.queryID||"");-1===n?t.peers.filter(function(e){return e!==t.pid}).forEach(function(t){localStorage.setItem(t+"."+e.query.queryID,JSON.stringify(e))}):t.peerEvents.splice(n,1)}),window.addEventListener("beforeunload",function(){return t.peers=t.peers.filter(function(e){return e!==t.pid}),localStorage.setItem("nsql-peers-"+t.id,JSON.stringify(t.peers)),!1})}n.isConnected=!0,n.tt.length&&(n.tt.forEach(function(t){return t()}),n.tt=[]),t.K(),o(n.tableNames)})}function f(){void 0!==t.getConfig().version?n.query("select").where(["key","=","db-version"]).manualExec({table:"_util"}).then(function(e){if(e.length){var i=e.length?e[0].value:t.getConfig().version,o=function(){if(i===t.getConfig().version)c();else{if(!t.getConfig().onVersionUpdate)return i=t.getConfig().version,void o();t.getConfig().onVersionUpdate(i).then(function(t){i=t,r.setFast(o)}).catch(s)}};o()}else n.query("upsert",{key:"db-version",value:t.getConfig().version}).manualExec({table:"_util"}).then(function(){c()})}):c()}function h(t){n.query("upsert",{key:"version",value:n.version}).manualExec({table:"_util"}).then(function(){t?n.extend("beforeConn","rebuild_idx").then(function(){f()}):f()})}n.dataModels=a.models,n.G=a.actions,n.X=a.views,n.Y=a.config,Object.keys(n.dataModels).forEach(function(t){var e=!1;n.dataModels[t]=n.dataModels[t].filter(function(t){return"*"!==t.key||"*"!==t.type||!(e=!0)}),n.skipPurge[t]=e}),n.plugins.forEach(function(t){t.didExec&&(n.pluginHasDidExec=!0)}),n.tableNames=Object.keys(n.dataModels),n.query("select").where(["key","=","version"]).manualExec({table:"_util"}).then(function(t){t.length?t[0].value<=1.21?h(!0):t[0].value<1.83?h(!1):f():h(!0)})})})},y.prototype.getActions=function(t){return this.G[t].map(function(t){return{name:t.name,args:t.args}})},y.prototype.getViews=function(t){return this.X[t].map(function(t){return{name:t.name,args:t.args}})},y.prototype.getConfig=function(){return this.Y||{}},y.prototype.avFilter=function(t){return this.nt=t,this},y.prototype.use=function(t){return this.plugins.push(t),this},y.prototype.on=function(t,e){var n=this,i=n.sTable,r=n.it.length,o=t.split(" ");if(Array.isArray(i))return this;for(n.rt[i]||(n.rt[i]=new a.ReallySmallEvents),r=o.length;r--;)-1!==n.it.indexOf(o[r])&&n.rt[i].on(o[r],e);return n.et()},y.prototype.off=function(t,e){var n=t.split(" "),i=n.length,r=this.sTable;if(Array.isArray(r))return this;for(;i--;)-1!==this.it.indexOf(n[i])&&this.rt[r].off(n[i],e);return this.et()},y.prototype.et=function(){var t=this;return this.ot={},Object.keys(this.rt).concat(["*"]).forEach(function(e){t.ot[e]=0<t.it.reduce(function(n,i){return n+(t.rt[e]&&t.rt[e].eventListeners[i]?t.rt[e].eventListeners[i].length:0)},0)}),this.hasAnyEvents=!1,Object.keys(this.ot).forEach(function(e){t.hasAnyEvents=t.hasAnyEvents||t.ot[e]}),this},y.prototype.model=function(t,e,n){var i=this,r=this,o=r.sTable;if(Array.isArray(o))return this;r.rt[o]||(r.rt[o]=new a.ReallySmallEvents);var s=!1;if(!n){if(-1!==["string","safestr","timeId","timeIdms","uuid","int","float","number","array","map","bool","blob","any"].indexOf(o.replace(/\W/gim,""))||0===o.indexOf("_")||null!==o.match(/[\(\)\]\[\.]/g))throw Error("Invalid Table Name! https://docs.nanosql.io/setup/data-models");(t||[]).forEach(function(t){if(null!==t.key.match(/[\(\)\]\[\.]/g)||0===t.key.indexOf("_"))throw Error("Invalid Data Model! https://docs.nanosql.io/setup/data-models")})}return r.toColRules[o]={},(t||[]).forEach(function(t){t.props&&t.props.forEach(function(e){if(-1!==e.indexOf("from=>")&&-1!==e.indexOf("(")){var n=e.replace("from=>","").split("(").shift(),i=e.replace("from=>","").split("(").pop().replace(")","").split(",").map(function(t){return t.trim()});r.toColRules[o][t.key]=[n].concat(i)}0===e.indexOf("toColumn.")&&(n=e.replace(/toColumn\.(.*)\(.*\)/gim,"$1"),i=e.replace(/toColumn\..*\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}),r.toColRules[o][t.key]=[n].concat(i))}),t.props&&u.intersect(["pk","pk()"],t.props)&&(i.V[o]=t.key,i.U[o]=t.type,s=!0)}),(this.hasPK[o]=s)||(this.V[o]="_id_",t.unshift({key:"_id_",type:"uuid",props:["pk()"]})),r.dataModels[o]=t,r.X[o]=[],r.G[o]=[],r},y.prototype.views=function(t){return Array.isArray(this.sTable)||(this.X[this.sTable]=t),this},y.prototype.getView=function(t,e){return void 0===e&&(e={}),Array.isArray(this.sTable)?new Promise(function(t,e){return e()}):this.ut("View",this.X[this.sTable],t,e)},y.prototype.actions=function(t){return Array.isArray(this.sTable)||(this.G[this.sTable]=t),this},y.prototype.doAction=function(t,e){return Array.isArray(this.sTable)?new Promise(function(t,e){return e()}):this.ut("Action",this.G[this.sTable],t,e)},y.prototype.queryFilter=function(t){return this.queryMod=t,this},y.prototype.ut=function(t,e,n,i){var r=this,o=this,s=e.reduce(function(t,e){return e.name===n?e:t},null);return s?(o.st=n,o.nt?new Promise(function(e,n){o.nt(r.sTable,t,o.st||"",i,function(t){s.call(s.args?u.cleanArgs(s.args,t):{},o).then(e).catch(n)},function(t){n(t)})}):s.call(s.args?u.cleanArgs(s.args,i):{},o)):new Promise(function(t,e){return e("Action/View Not Found!")})},y.prototype.query=function(t,e){var n=this.st;return this.st=void 0,new o.ct(this,this.sTable,t,e,n)},y.prototype.onConnected=function(t){this.isConnected?t():this.tt.push(t)},y.prototype.triggerEvent=function(t){var e=this;if(e.ot["*"]||e.ot[t.table]){if("*"===t.table)return this;r.setFast(function(){t.types.forEach(function(n){e.rt["*"].trigger(n,t,e),e.rt["*"].trigger("*",t,e),t.table&&e.rt[t.table]&&e.rt[t.table].trigger(n,t,e)})})}return e},y.prototype.default=function(t){var e={};return Array.isArray(this.sTable)?{}:(this.dataModels[this.sTable].forEach(function(n){e[n.key]=t&&t[n.key]?t[n.key]:n.default,void 0===e[n.key]&&(e[n.key]=u.cast(n.type,null))}),e)},y.prototype.rawDump=function(t){var e=this;return new Promise(function(n,r){var o={};u.fastCHAIN(e.plugins,function(e,n,r){e.dumpTables?e.dumpTables(t).then(function(t){o=i({},o,t),r(o)}):r()}).then(function(){n(o)})})},y.prototype.rawImport=function(t,e){var n=this;return new Promise(function(i,r){u.fastCHAIN(n.plugins,function(n,i,r){n.importTables?n.importTables(t,e||function(t){}).then(r):r()}).then(function(){i()})})},y.prototype.disconnect=function(){return u.fastCHAIN(this.plugins,function(t,e,n){t.willDisconnect?t.willDisconnect(n):n()})},y.prototype.doTransaction=function(t){var e=this,n=this,r=[],o=u.random16Bits().toString(16);return new Promise(function(a,c){if(n.plugins.length){function f(){u.fastCHAIN(n.plugins,function(t,e,n){t.transactionBegin?t.transactionBegin(o,n):n()}).then(function(){Array.isArray(n.sTable)||t(function(t){var e=t||n.sTable;return{query:function(t,n){return new s.ft(t,n,e,r,o)}}},function(){var t=[];u.fastCHAIN(r,function(e,r,s){t.push(e.table),n.query(e.action,e.actionArgs).manualExec(i({},e,{table:e.table,transaction:!0,queryID:o})).then(s)}).then(function(i){u.fastCHAIN(e.plugins,function(t,e,n){t.transactionEnd?t.transactionEnd(o,n):n()}).then(function(){t.filter(function(t,e,n){return n.indexOf(t)===e}).forEach(function(t){0!==t.indexOf("_")&&n.triggerEvent({query:r[0],table:t,time:(new Date).getTime(),result:i,types:["transaction"],actionOrView:"",notes:[],transactionID:o,affectedRowPKS:[],affectedRows:[]})}),a(i)})})})})}e.isConnected?f():e.onConnected(f)}else c("nSQL: Nothing to do, no plugins!")})},y.prototype.config=function(t){return this.Y=t,this},y.prototype.observable=function(t,e){return new l.Observer(this,t,e||[])},y.prototype.extend=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i=this;return new Promise(function(n,r){function o(){if(i.plugins.length){var t=e,o=[];u.fastCHAIN(i.plugins,function(e,n,i){e.extend?e.extend(function(e,n){t=e,o=n,i()},t,o):i()}).then(function(){n(o)})}else r("No plugins!")}if("beforeConn"===e[0])return e.shift(),void o();t.isConnected?o():t.onConnected(o)})},y.prototype.loadJS=function(t,e,n,i){var r=this;return n?this.doTransaction(function(n,i){e.forEach(function(e){n(t).query("upsert",e).exec()}),i()}):new Promise(function(n,o){u.fastCHAIN(e,function(n,o,s){i&&i(Math.round((o+1)/e.length*1e4)/100),r.query("upsert",n).manualExec({table:t}).then(s)}).then(function(t){n(t.map(function(t){return t.shift()}))})})},y.prototype.JSONtoCSV=function(t,e,n){var i=[];if(!t.length)return"";var r=[];return r=n||(t.forEach(function(t){r=Object.keys(t).concat(r)}),r.filter(function(t,e,n){return n.indexOf(t)===e})),e&&i.push(r.join(",")),t.forEach(function(t){i.push(r.map(function(e){return null===t[e]||void 0===t[e]?"":"string"==typeof t[e]?'"'+t[e].replace(/\"/g,'""')+'"':"boolean"==typeof t[e]?!0===t[e]?"true":"false":"object"==typeof t[e]?'"'+JSON.stringify(t[e]).replace(/\"/g,'""')+'"':t[e]}).join(","))}),i.join("\r\n")},y.prototype.csvToArray=function(t){for(var e,n="",i=[""],r=[i],o=0,s=0,a=!0,u=0,c=t;u<c.length;u++)'"'===(e=c[u])?(a&&e===n&&(i[o]+=e),a=!a):","===e&&a?e=i[++o]="":"\n"===e&&a?("\r"===n&&(i[o]=i[o].slice(0,-1)),i=r[++s]=[e=""],o=0):i[o]+=e,n=e;return r[0]},y.prototype.CSVtoJSON=function(t,e){var n=this,i=[];return t.split(/\r?\n|\r|\t/gm).map(function(t,r){if(0!==r){var o=n.csvToArray(t);if(o){o=o.map(function(t){return t.trim()});for(var s=i.length,a={};s--;)if(o[s])if("true"===o[s]||"false"===o[s])a[i[s]]="true"===o[s];else if(0===o[s].indexOf("{")||0===o[s].indexOf("["))try{a[i[s]]=JSON.parse(o[s])}catch(t){a[i[s]]=o[s]}else 0===o[s].indexOf('"')?a[i[s]]=o[s].slice(1,o[s].length-1).replace(/\"\"/gim,'"'):a[i[s]]=o[s];return e?e(a):a}}else i=t.split(",")}).filter(function(t){return t})},y.prototype.loadCSV=function(t,e,n,i,r){var o=this,s=this.CSVtoJSON(e,i);return n?this.doTransaction(function(e,n){s.forEach(function(n){e(t).query("upsert",n).exec()}),n()}):new Promise(function(e,n){u.fastCHAIN(s,function(e,n,i){r&&r(Math.round((n+1)/s.length*1e4)/100),o.query("upsert",e).manualExec({table:t}).then(i)}).then(function(t){e(t.map(function(t){return t.shift()}))})})},y.earthRadius=6371,y);function y(){this.version=1.83,this.tt=[];var t=this;t.isConnected=!1,t.focused=!0,t.G={},t.X={},t.dataModels={},t.it=["*","change","delete","upsert","drop","select","error","peer-change"],t.ot={},t.tableNames=[],t.plugins=[],t.hasPK={},t.skipPurge={},t.toRowFns={},t.V={},t.U={},t.toColFns={},t.toColRules={},t.rowFilters={},t.peers=[],t.peerEvents=[],t.pid=u.uuid(),t.z=[],t.$=0,t.hasAnyEvents=!1;for(var e=0;e<1e3;e++)t.z.push(u.random16Bits());t.rt={},t.rt["*"]=new a.ReallySmallEvents,t.iB=new c.NanoSQLDefaultBackend;var n={models:{},actions:{},views:{},config:{},parent:this};t.iB.willConnect&&t.iB.willConnect(n,function(){t.iB.didConnect&&t.iB.didConnect(n,function(){})}),this.K=this.K.bind(this)}e.NanoSQLInstance=d;var v={};d.whereFunctions={levenshtein:function(t,e,n,i){var r=u.objQuery(i,t,e)||"",o=r+"::"+n;return v[o]||(v[o]=h(r,n)),v[o]},arrayObjSrch:function(t,e,n,i,r){var o=u.objQuery(n,t,e);if(Array.isArray(o)&&o.length){var s,a=i.split("=");if(o.forEach(function(t){var e=u.objQuery(a[0],t);e=isNaN(e)?e:parseFloat(e),a[1]=isNaN(a[1])?a[1]:parseFloat(a[1]),e===a[1]&&(s=t)}),void 0!==s)return u.objQuery(r,s)}},crow:function(t,e,n,i,r,o){var s=r||"lat",a=o||"lon",c=u.objQuery(s,t,e),f=u.objQuery(a,t,e);return u.crowDistance(c,f,n,i,d.earthRadius)},sum:function(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return n.reduce(function(n,i){var r=u.objQuery(i,t,e)||0;return Array.isArray(r)?n+r.reduce(function(t,e){return t+parseFloat(e||0)},0):n+parseFloat(r)},0)},avg:function(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];var r=0;return n.reduce(function(n,i){var o=u.objQuery(i,t,e)||0;return Array.isArray(o)?(r+=o.length,n+o.reduce(function(t,e){return t+parseFloat(e||0)},0)):(r++,n+parseFloat(o))},0)/r}},d.functions={COUNT:{type:"A",call:function(t,e,n,i){e(i&&"*"!==i?t.filter(function(t){return u.objQuery(i,t,n)}).length:t.length)}},MAX:{type:"A",call:function(t,e,n,i){if(t.length){var r=u.objQuery(i,t[0])||0,o=t[0];t.forEach(function(t){u.objQuery(i,t,n),u.objQuery(i,t)>r&&(o=t,r=u.objQuery(i,t,n))}),e(r,o)}else e(0)}},MIN:{type:"A",call:function(t,e,n,i){if(t.length){var r=u.objQuery(i,t[0],n)||0,o=t[0];t.forEach(function(t){var e=u.objQuery(i,t,n);e<r&&(r=e,o=t)}),e(r,o)}else e(0)}},AVG:{type:"A",call:function(t,e,n,i){e(t.reduce(function(t,e){return t+(u.objQuery(i,e,n)||0)},0)/t.length)}},SUM:{type:"A",call:function(t,e,n,i){e(t.reduce(function(t,e){return t+(u.objQuery(i,e,n)||0)},0))}},LOWER:{type:"S",call:function(t,e,n,i){e(t.map(function(t){return String(u.objQuery(i,t,n)).toLowerCase()}))}},UPPER:{type:"S",call:function(t,e,n,i){e(t.map(function(t){return String(u.objQuery(i,t,n)).toUpperCase()}))}},CAST:{type:"S",call:function(t,e,n,i,r){e(t.map(function(t){return u.cast(r,u.objQuery(i,t,n))}))}},ABS:{type:"S",call:function(t,e,n,i){e(t.map(function(t){return Math.abs(u.objQuery(i,t,n))}))}},CEIL:{type:"S",call:function(t,e,n,i){e(t.map(function(t){return Math.ceil(u.objQuery(i,t,n))}))}},POW:{type:"S",call:function(t,e,n,i,r){e(t.map(function(t){return Math.pow(u.objQuery(i,t,n),parseInt(r))}))}},ROUND:{type:"S",call:function(t,e,n,i){e(t.map(function(t){return Math.round(u.objQuery(i,t,n))}))}},SQRT:{type:"S",call:function(t,e,n,i){e(t.map(function(t){return Math.sqrt(u.objQuery(i,t,n))}))}}};var b=new d;e.nSQL=function(t){return b.table(t)},"undefined"!=typeof window&&(window["nano-sql"]={nSQL:e.nSQL,NanoSQLInstance:d})},function(t,e,n){var i=this&&this.W||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};Object.defineProperty(e,"e",{value:!0});var r=n(1),o=n(0),s=n(3),a=(u.prototype.connect=function(t){t()},u.prototype.setID=function(t){this.at=t},u.prototype.makeTable=function(t,e){var n=this;this.ht[t]={},this.lt[t]=new s.DatabaseIndex,e.forEach(function(e){if(e.props&&o.intersect(["pk","pk()"],e.props)&&(n.lt[t].pkType=e.type,n.vt[t]=e.key,e.props&&o.intersect(["ai","ai()"],e.props)&&("int"===e.type||"number"===e.type)&&(n.lt[t].doAI=!0),(e.props&&o.intersect(["ns","ns()"],e.props)||-1!==["uuid","timeId","timeIdms"].indexOf(n.lt[t].pkType))&&(n.lt[t].sortIndex=!1),n.dt)){var i=localStorage.getItem(n.at+"*"+t+"_idx");i&&n.lt[t].set(JSON.parse(i))}})},u.prototype.write=function(t,e,n,r,s){var a,u;if(e=e||o.generateID(this.lt[t].pkType,this.lt[t].ai))if(-1===this.lt[t].indexOf(e)&&(this.lt[t].add(e),this.dt&&localStorage.setItem(this.at+"*"+t+"_idx",JSON.stringify(this.lt[t].keys()))),this.dt){var c=i({},n,((a={})[this.vt[t]]=e,a));localStorage.setItem(this.at+"*"+t+"__"+e,JSON.stringify(c)),r(c)}else c=i({},n,((u={})[this.vt[t]]=e,u)),this.ht[t][e]=o.deepFreeze(c),r(c);else s(new Error("nSQL: Can't add a row without a primary key!"))},u.prototype.delete=function(t,e,n){-1!==this.lt[t].indexOf(e)&&(this.lt[t].remove(e),this.dt&&localStorage.setItem(this.at+"*"+t+"_idx",JSON.stringify(this.lt[t].keys()))),this.dt?localStorage.removeItem(this.at+"*"+t+"__"+e):delete this.ht[t][e],n()},u.prototype.read=function(t,e,n){if(this.dt){var i=localStorage.getItem(this.at+"*"+t+"__"+e);n(i?JSON.parse(i):void 0)}else n(this.ht[t][e])},u.prototype.rangeRead=function(t,e,n,i,o,s){var a=this,u=this.lt[t].keys(),c=-1===[typeof i,typeof o].indexOf("undefined"),f=c?[i,o]:[0,u.length-1];if(u.length){function h(){l++,++p%500==0?r.setFast(d):d()}s&&c||!1!==this.lt[t].sortIndex||(u=u.sort()),s&&c&&(f=f.map(function(e){var n=a.lt[t].indexOf(e);return-1!==n?n:a.lt[t].getLocation(e)}));var l=f[0],p=0,d=function(){if(l<=f[1])if(a.dt){var i=localStorage.getItem(a.at+"*"+t+"__"+u[l]);e(i?JSON.parse(i):void 0,l,h)}else e(a.ht[t][u[l]],l,h);else n()};d()}else n()},u.prototype.drop=function(t,e){var n=this;this.dt?(localStorage.setItem(this.at+"*"+t+"_idx",JSON.stringify([])),this.lt[t].keys().forEach(function(e){localStorage.removeItem(n.at+"*"+t+"__"+e)})):this.ht[t]={},this.lt[t]=this.lt[t].clone(),e()},u.prototype.getIndex=function(t,e,n){n(e?this.lt[t].keys().length:this.lt[t].keys())},u.prototype.destroy=function(t){var e=this;o.fastALL(Object.keys(this.lt),function(t,n,i){e.drop(t,i)}).then(t)},u.prototype.setNSQL=function(t){s.syncPeerIndex(t,this.lt)},u);function u(t){this.vt={},this.ht={},this.lt={},this.dt=t||!1}e.bt=a},function(t,e,n){var i=this&&this.W||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};Object.defineProperty(e,"e",{value:!0});var r=n(1),o=n(0),s=n(3),a=(u.prototype.onError=function(t){throw console.error(t),new Error("nSQL: IndexedDB Error!")},u.prototype.connect=function(t){var e=this;this.pt=o.hash(JSON.stringify(this.wt));var n=1;this.version?n=this.version:(n=parseInt(localStorage.getItem(this.at+"-idb-version")||"")||1,(localStorage.getItem(this.at+"-idb-hash")||this.pt)!==this.pt&&n++,localStorage.setItem(this.at+"-idb-version",String(n)),localStorage.setItem(this.at+"-idb-hash",this.pt));var i=indexedDB.open(this.at,n),r={};i.onerror=this.onError,i.onupgradeneeded=function(t){e.yt=t.target.result,Object.keys(e.lt).forEach(function(t){e.yt.objectStoreNames.contains(t)||e.yt.createObjectStore(t,{keyPath:e.vt[t]}),r[t]=[]})},i.onsuccess=function(n){e.yt=n.target.result,o.fastALL(Object.keys(e.lt),function(t,n,i){!function(t,n){var i=[];e.store(t,"readonly",function(t,r){var o=r.openCursor();o.onsuccess=function(t){var e=t.target.result;e&&(i.push(e.key),e.continue())},o.onerror=e.onError,t.oncomplete=function(){n(i)}})}(t,function(n){e.lt[t].set(n),i()})}).then(function(){t()})}},u.prototype.store=function(t,e,n){var i=this.yt.transaction(t,e);i.onabort=this.onError,i.onerror=this.onError,n(i,i.objectStore(t))},u.prototype.setID=function(t){this.at=t},u.prototype.makeTable=function(t,e){var n=this;this.lt[t]=new s.DatabaseIndex,(this.wt[t]=e).forEach(function(e){e.props&&o.intersect(["pk","pk()"],e.props)&&(n.lt[t].pkType=e.type,n.vt[t]=e.key,e.props&&o.intersect(["ai","ai()"],e.props)&&("int"===e.type||"number"===e.type)&&(n.lt[t].doAI=!0),(e.props&&o.intersect(["ns","ns()"],e.props)||-1!==["uuid","timeId","timeIdms"].indexOf(n.lt[t].pkType))&&(n.lt[t].sortIndex=!1))})},u.prototype.write=function(t,e,n,r,s){var a;if(e=e||o.generateID(this.lt[t].pkType,this.lt[t].ai)){-1===this.lt[t].indexOf(e)&&this.lt[t].add(e);var u=i({},n,((a={})[this.vt[t]]=e,a));this.store(t,"readwrite",function(t,e){try{e.put(u).onsuccess=function(){r(u)}}catch(t){console.error(t),s(t)}})}else s(new Error("nSQL: Can't add a row without a primary key!"))},u.prototype.delete=function(t,e,n){var i=this;-1!==this.lt[t].indexOf(e)&&this.lt[t].remove(e),this.store(t,"readwrite",function(t,r){var o="_clear_"===e?r.clear():r.delete(e);o.onerror=i.onError,o.onsuccess=function(t){n()}})},u.prototype.read=function(t,e,n){var i=this;-1!==this.lt[t].indexOf(e)?this.store(t,"readonly",function(t,r){var o=r.get(e);o.onerror=i.onError,o.onsuccess=function(){n(o.result)}}):n(null)},u.prototype.rangeRead=function(t,e,n,i,o,s){var a=this,u=this.lt[t].keys(),c=-1===[typeof i,typeof o].indexOf("undefined"),f=c?[i,o]:[0,u.length-1];if(u.length){function h(){l++,++p%500==0?r.setFast(d):d()}s&&c||!1!==this.lt[t].sortIndex||(u=u.sort()),s&&c&&(f=f.map(function(e){var n=a.lt[t].indexOf(e);return-1!==n?n:a.lt[t].getLocation(e)}));var l=f[0],p=0,d=function(){l<=f[1]?a.read(t,u[l],function(t){e(t,l,h)}):n()};d()}else n()},u.prototype.drop=function(t,e){this.lt[t]=this.lt[t].clone(),this.delete(t,"_clear_",function(){e()})},u.prototype.getIndex=function(t,e,n){n(e?this.lt[t].keys().length:this.lt[t].keys())},u.prototype.destroy=function(t){var e=this;localStorage.removeItem(this.at+"-idb-version"),localStorage.removeItem(this.at+"-idb-hash"),o.fastALL(Object.keys(this.lt),function(t,n,i){e.drop(t,i)}).then(t)},u.prototype.setNSQL=function(t){s.syncPeerIndex(t,this.lt)},u);function u(t){this.version=t,this.vt={},this.lt={},this.wt={}}e._t=a},function(t,e,n){var i=this&&this.W||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};Object.defineProperty(e,"e",{value:!0});var r=n(1),o=n(0),s=n(3),a=(u.prototype.setID=function(t){this.at=t},u.prototype.connect=function(t){var e=this;this.yt=window.openDatabase(this.at,"1.0",this.at,this.mt||o.isAndroid?5e6:1),o.fastALL(Object.keys(this.vt),function(t,n,i){e.gt(!0,'CREATE TABLE IF NOT EXISTS "'+t+'" (id '+(e.Ot[t]?"REAL":"TEXT")+" PRIMARY KEY UNIQUE, data TEXT)",[],function(){e.gt(!1,'SELECT id FROM "'+t+'"',[],function(n){for(var r=[],o=0;o<n.rows.length;o++)r.push(n.rows.item(o).id);e.lt[t].sortIndex&&(r=r.sort(function(t,e){return e<t?1:-1})),e.lt[t].set(r),i()})})}).then(t)},u.prototype.St=function(t){if(-1===Object.keys(this.vt).indexOf(t))throw Error("No table "+t+" found!");return'"'+t+'"'},u.prototype.makeTable=function(t,e){var n=this;this.lt[t]=new s.DatabaseIndex,e.forEach(function(e){e.props&&o.intersect(["pk","pk()"],e.props)&&(n.lt[t].pkType=e.type,n.vt[t]=e.key,e.props&&o.intersect(["ai","ai()"],e.props)&&("int"===e.type||"number"===e.type)&&(n.lt[t].doAI=!0),-1!==["number","float","int"].indexOf(n.lt[t].pkType)&&(n.Ot[t]=!0),(e.props&&o.intersect(["ns","ns()"],e.props)||-1!==["uuid","timeId","timeIdms"].indexOf(n.lt[t].pkType))&&(n.lt[t].sortIndex=!1))})},u.prototype.gt=function(t,e,n,i){function r(t){t.executeSql(e,n,function(t,e){i(e)},function(t,i){return console.error(e,n,i),!1})}t?this.yt.transaction(r):this.yt.readTransaction(r)},u.prototype.write=function(t,e,n,r,s){var a=this;(e=e||o.generateID(this.lt[t].pkType,this.lt[t].ai))?this.gt(!1,"SELECT id FROM "+this.St(t)+" WHERE id = ?",[e],function(o){var s,u;if(o.rows.length){var c=i({},n,((u={})[a.vt[t]]=e,u));a.gt(!0,"UPDATE "+a.St(t)+" SET data = ? WHERE id = ?",[JSON.stringify(c),e],function(){r(c)})}else{a.lt[t].add(e);var f=i({},n,((s={})[a.vt[t]]=e,s));a.gt(!0,"INSERT into "+a.St(t)+" (id, data) VALUES (?, ?)",[e,JSON.stringify(f)],function(t){r(f)})}}):s(new Error("nSQL: Can't add a row without a primary key!"))},u.prototype.delete=function(t,e,n){-1!==this.lt[t].indexOf(e)&&this.lt[t].remove(e),this.gt(!0,"DELETE FROM "+this.St(t)+" WHERE id = ?",[e],function(){n()})},u.prototype.read=function(t,e,n){this.gt(!1,"SELECT data FROM "+this.St(t)+" WHERE id = ?",[e],function(t){t.rows.length?n(JSON.parse(t.rows.item(0).data)):n(void 0)})},u.prototype.batchRead=function(t,e,n){var i=this,r=o.splitArr(e,500),s=[];o.fastCHAIN(r,function(e,n,r){i.gt(!1,"SELECT data from "+i.St(t)+" WHERE id IN ("+e.map(function(t){return"?"}).join(", ")+") ORDER BY id",e,function(t){for(var e=t.rows.length;e--;)s.unshift(JSON.parse(t.rows.item(e).data));r()})}).then(function(){n(s)})},u.prototype.rangeRead=function(t,e,n,i,o,s){var a=this,u=this.lt[t].keys(),c=-1===[typeof i,typeof o].indexOf("undefined"),f=c?[i,o]:[];if(u.length){s&&c&&(f=f.map(function(e){return a.lt[t].getLocation(e)})),s&&c||!1!==this.lt[t].sortIndex||(u=u.sort());var h=f[0]||0,l=[],p=f[0],d="SELECT data from "+this.St(t);if(f.length)for(u[p];p<=f[1];)l.push(u[p]),p++;d+=" ORDER BY id",l.length?this.batchRead(t,l,function(t){var i=0,o=function(){t.length>i?e(t[i],h,function(){h++,++i%500==0?r.setFast(o):o()}):n()};o()}):this.gt(!1,d,l,function(t){var i=0,o=function(){t.rows.length>i?e(JSON.parse(t.rows.item(i).data),h,function(){h++,++i%500==0?r.setFast(o):o()}):n()};o()})}else n()},u.prototype.drop=function(t,e){this.lt[t]=this.lt[t].clone(),this.gt(!0,"DELETE FROM "+this.St(t),[],function(t){e()})},u.prototype.getIndex=function(t,e,n){n(e?this.lt[t].keys().length:this.lt[t].keys())},u.prototype.destroy=function(t){var e=this;o.fastALL(Object.keys(this.lt),function(t,n,i){e.drop(t,i)}).then(t)},u.prototype.setNSQL=function(t){s.syncPeerIndex(t,this.lt)},u);function u(t){this.vt={},this.lt={},this.Ot={},this.mt=1e3*(t||0)*1e3}e.jt=a},function(t,e,n){"use strict";t.exports=function(t,e,n){var o,s,a,u,c,f,h,l;if(t===e)return 0;if(o=t.length,s=e.length,0===o)return s;if(0===s)return o;for(n&&(t=t.toLowerCase(),e=e.toLowerCase()),h=0;h<o;)r[h]=t.charCodeAt(h),i[h]=++h;for(l=0;l<s;)for(a=e.charCodeAt(l),u=c=l++,h=-1;++h<o;)f=a===r[h]?c:c+1,c=i[h],i[h]=u=u<c?u<f?u+1:f:c<f?c+1:f;return u};var i=[],r=[]},function(t,e,n){t.exports=n(6)},function(t,e,n){var i=this&&this.W||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function r(t,e,n){"pending"===t.Et.state?(t.Et.state="executing",1!==t.yt.plugins.length||t.yt.hasAnyEvents||t.Et.ttl?o.fastCHAIN(t.yt.plugins,function(e,n,i,r){e.doExec?e.doExec(t.Et,function(e){t.Et=e||t.Et,i()},r):i()}).then(function(){if(t.yt.hasPK[t.Et.table]?e(t.Et.result):e(t.Et.result.map(function(t){return i({},t,{kt:void 0})})),t.yt.hasAnyEvents||t.yt.pluginHasDidExec||t.Et.ttl){var n=function(){switch(t.Et.action){case"select":return[t.Et.action];case"delete":case"upsert":case"drop":return[t.Et.action,"change"];default:return[]}}(),r=t.Et.result&&t.Et.result.length,a={table:t.Et.table,query:t.Et,time:Date.now(),result:t.Et.result,notes:[],types:n,actionOrView:t.Nt,transactionID:t.Et.transaction?t.Et.queryID:void 0,affectedRowPKS:r?(t.Et.result[0]||s).affectedRowPKS:[],affectedRows:r?(t.Et.result[0]||s).affectedRows:[]};if((a.affectedRowPKS||[]).length&&t.Et.ttl){var u=Date.now()+1e3*(t.Et.ttl||0);o.fastCHAIN(a.affectedRowPKS||[],function(e,n,i){t.yt.query("upsert",{key:t.Et.table+"."+e,table:t.Et.table,cols:t.Et.ttlCols,date:u}).manualExec({table:"_ttl"}).then(i)}).then(function(){t.yt.K()})}o.fastCHAIN(t.yt.plugins,function(t,e,n){t.didExec?t.didExec(a,function(t){a=t,n()}):n()}).then(function(){t.Et.transaction||t.yt.triggerEvent(a)})}}).catch(n):t.yt.plugins[0].doExec(t.Et,function(n){t.Et=n,t.yt.hasPK[t.Et.table]?e(t.Et.result):e(t.Et.result.map(function(t){return i({},t,{kt:void 0})}))},n)):n(new Error("nSQL: Can't call query twice!"))}Object.defineProperty(e,"e",{value:!0});var o=n(0),s={affectedRowPKS:[],affectedRows:[]},a={},u=(c.prototype.where=function(t){return this.Et.where=t,this},c.prototype.range=function(t,e){return this.Et.range=[t,e],this},c.prototype.on=function(t){return this.Et.on=t,this},c.prototype.debounce=function(t){return this.Et.debounce=t||250,this},c.prototype.orm=function(t){return this.Et.orm=t,this},c.prototype.orderBy=function(t){return this.Et.orderBy=t,this},c.prototype.groupBy=function(t){return this.Et.groupBy=t,this},c.prototype.having=function(t){return t.length&&Array.isArray(t)||(this.Tt="Having condition requires an array!"),this.Et.having=t,this},c.prototype.join=function(t){var e=this;if(Array.isArray(this.Et.table))throw new Error("Can't JOIN with instance table!");var n="Join commands requires table and type arguments!";return Array.isArray(t)?t.forEach(function(t){t.table&&t.type||(e.Tt=n)}):t.table&&t.type||(this.Tt=n),this.Et.join=t,this},c.prototype.limit=function(t){return this.Et.limit=t,this},c.prototype.trieSearch=function(t,e){return this.Et.trie={column:t,search:e},this},c.prototype.comment=function(t){return this.Et.comments.push(t),this},c.prototype.extend=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.Et.extend=t,this},c.prototype.offset=function(t){return this.Et.offset=t,this},c.prototype.emit=function(){return this.Et},c.prototype.ttl=function(t,e){if(void 0===t&&(t=60),"upsert"!==this.Et.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this.Et.ttl=t,this.Et.ttlCols=e||[],this},c.prototype.toCSV=function(t){var e=this,n=this;return new Promise(function(i,r){n.exec().then(function(r){var o="string"==typeof e.Et.table?e.yt.dataModels[e.Et.table].map(function(t){return t.key}):void 0;i(n.yt.JSONtoCSV(r,t||!1,o))})})},c.prototype.manualExec=function(t){return this.Et=i({},this.Et,t),this.exec()},c.prototype.denormalizationQuery=function(t){var e=this;return new Promise(function(n,i){switch(t){case"tocolumn":var s={};e.Et.actionArgs&&e.Et.actionArgs.length?Object.keys(e.yt.toColRules[e.Et.table]).filter(function(t){return-1!==e.Et.actionArgs.indexOf(t)}).forEach(function(t){s[t]=e.yt.toColRules[e.Et.table][t]}):s=e.yt.toColRules[e.Et.table],e.Et.action="select",e.Et.actionArgs=void 0;var a=Object.keys(s);r(e,function(t){o.fastCHAIN(t,function(t,n,i){Object.isFrozen(t)&&(t=o.u(t)),o.fastALL(a,function(n,i,r){var o=e.yt.toColFns[e.Et.table][s[n][0]];o?o.apply(null,[t[n],function(e){t[n]=e,r()}].concat(s[n].filter(function(t,e){return 0<e}).map(function(e){return t[e]}))):r()}).then(function(){e.yt.query("upsert",t).manualExec({table:e.Et.table}).then(i).catch(i)})}).then(function(){n([{msg:t.length+" rows modified"}])})},i);break;case"torow":var u=(e.Et.actionArgs||"").replace("()","");if(!e.yt.toRowFns[e.Et.table]||!e.yt.toRowFns[e.Et.table][u])return void i("No function "+e.Et.actionArgs+" found to perform updates!");var c=e.yt.toRowFns[e.Et.table][u],f=e.yt.V[e.Et.table];if(e.Et.on&&e.Et.on.length)return void o.fastALL(e.Et.on,function(t,n,i){c(t,{},function(n){n[f]=t,e.yt.query("upsert",n).manualExec({table:e.Et.table}).then(i).catch(i)})}).then(function(){n([{msg:(e.Et.on||[]).length+" rows modified or added."}])});e.Et.action="select",e.Et.actionArgs=void 0,r(e,function(t){o.fastALL(t,function(t,n,i){Object.isFrozen(t)&&(t=o.u(t)),c(t[f],t,function(n){n[f]=t[f],e.yt.query("upsert",n).manualExec({table:e.Et.table}).then(i).catch(i)})}).then(function(){n([{msg:t.length+" rows modified"}])})},i)}})},c.prototype.getCursor=function(t){var e=this;return void 0===t&&(t=20),new Promise(function(n,r){if(e.Et.offset||e.Et.limit||e.Et.range)r("nSQL: Can't use limit/offset with getCursor!");else{var o=-1;n(function(){return o++,e.manualExec(i({},e.Et,{range:[t,t*o]}))})}})},c.prototype.exec=function(){var t=this;if(Array.isArray(this.Et.table))return new Promise(function(e,n){t.yt.iB.doExec&&t.yt.iB.doExec(t.Et,function(t){e(t.result)},n)});if("*"===this.Et.table)return Promise.resolve([]);var e=this,n=(this.Et.action||"").toLowerCase().trim();if(-1<["tocolumn","torow"].indexOf(n)){if(this.Et.debounce){var i=o.hash(JSON.stringify([this.Et.table,n,this.Et.actionArgs,this.Et.on,this.Et.where].filter(function(t){return t})));return new Promise(function(e,r){a[i]&&clearTimeout(a[i]),a[i]=setTimeout(function(){t.denormalizationQuery(n).then(e).catch(r)},t.Et.debounce)})}return this.denormalizationQuery(n)}if(!(-1<["select","upsert","delete","drop","show tables","describe"].indexOf(n)))return Promise.reject(new Error("nSQL: No valid database action!"));var s=this.Et.actionArgs||("select"===n?[]:{}),u=[];return"upsert"===n?(u=Array.isArray(s)?s:[s]).forEach(function(e,n){t.yt.rowFilters[t.Et.table]&&(u[n]=t.yt.rowFilters[t.Et.table](u[n]));for(var i={},r=t.yt.dataModels[t.Et.table],s=0;s<r.length;)void 0!==u[n][r[s].key]&&(i[r[s].key]=o.cast(r[s].type,u[n][r[s].key])),s++;if(t.yt.skipPurge[t.Et.table]){var a=r.map(function(t){return t.key});Object.keys(u[n]).filter(function(t){return-1===a.indexOf(t)}).forEach(function(t){i[t]=u[n][t]})}u[n]=i}):u=this.Et.actionArgs,this.Et.action=n,this.Et.actionArgs=this.Et.actionArgs?u:void 0,new Promise(function(n,i){function o(){if(e.yt.plugins.length||(e.Tt="nSQL: No plugins, nothing to do!"),e.Tt)i(e.Tt);else if(t.yt.queryMod){var o=t.yt.queryMod(t.Et,function(e){t.Et=e,r(t,n,i)});void 0!==o&&o.then(function(e){t.Et=e,r(t,n,i)}).catch(i)}else r(t,n,i)}t.yt.isConnected||0===t.Et.table.indexOf("_")?o():t.yt.onConnected(o)})},c);function c(t,e,n,i,r){this.yt=t,this.Nt=r||"",this.Et={table:e,comments:[],state:"pending",queryID:Date.now()+"."+this.yt.fastRand().toString(16),action:n,actionArgs:i,result:[]}}e.ct=u},function(t,e){Object.defineProperty(e,"e",{value:!0});var n=(i.prototype.where=function(t){return this.thisQ.where=t,this},i.prototype.exec=function(){this.It.push(this.thisQ)},i);function i(t,e,n,i,r){this.thisQ={state:"pending",table:n,action:t,actionArgs:e,queryID:r,transaction:!0,result:[],comments:[]},this.It=i}e.ft=n},function(t,e){Object.defineProperty(e,"e",{value:!0});var n=(i.prototype.on=function(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)},i.prototype.off=function(t,e){var n=this;this.eventListeners[t]&&this.eventListeners[t].length&&this.eventListeners[t].forEach(function(i,r){i===e&&n.eventListeners[t].splice(r,1)})},i.prototype.trigger=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.eventListeners[t]&&this.eventListeners[t].forEach(function(t){return t.apply(void 0,e)})},i);function i(){this.eventListeners={}}e.ReallySmallEvents=n,e.RSE=new n},function(t,e,n){var i=this&&this.W||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};Object.defineProperty(e,"e",{value:!0});var r=n(6),o=n(16),s=n(0),a=n(18),u=n(1),c=(f.prototype.willConnect=function(t,e){this.parent=t.parent,this.At=new a.Mt(t.parent,i({},t.config)),this.At.init(t.models,function(n){t.models=i({},t.models,n),e(t)})},f.prototype.getId=function(){return this.At.at},f.prototype.doExec=function(t,e,n){t.state="complete",new o.xt(this.At).doQuery(t,e,n)},f.prototype.dumpTables=function(t){var e=this;return new Promise(function(n,i){var r={},o=t&&t.length?t:Object.keys(e.At.tableInfo);s.fastALL(o,function(t,n,i){r[t]=[],e.At.adapters[0].adapter.rangeRead(t,function(e,n,i){r[t].push(e),i()},i)}).then(function(){n(r)})})},f.prototype.importTables=function(t,e){var n=this;return new Promise(function(i,r){var o=0,a=0;Object.keys(t).forEach(function(e){o+=(t[e]||[]).length||0}),s.fastALL(Object.keys(t),function(i,r,s,c){var f=n.At.tableInfo[i].Rt,h=(t[i]||[]).length||0,l=0,p=function(){if(l<h){var r=t[i][l];l++,a++,r[f]?n.At.adapterWrite(i,r[f],r,function(){e(Math.round((a+1)/o*1e4)/100),l%500==0?u.setFast(p):p()},c):(e(Math.round((a+1)/o*1e4)/100),l%500==0?u.setFast(p):p())}else s()};p()}).then(function(){i()})})},f.prototype.willDisconnect=function(t){s.fastALL(this.At.adapters||[],function(t,e,n){t.disconnect?t.disconnect(n):n()}).then(t)},f.prototype.extend=function(t,e,n){var i=this;switch(e[0]){case"clone":var o=new r.NanoSQLInstance;Object.keys(this.parent.dataModels).forEach(function(t){o.table(t).model(i.parent.dataModels[t],[],!0)}),o.config({id:this.At.at,mode:e[1]}).connect().then(function(){s.fastCHAIN(Object.keys(i.parent.dataModels),function(t,e,n){console.log("Importing "+t+"..."),i.parent.rawDump([t]).then(function(t){return o.rawImport(t)}).then(n)}).then(function(){t(e,[])})});break;case"flush":var a;a=e[1]?[e[1]]:this.parent.tableNames,s.fastCHAIN(a,function(t,e,n){i.At.Lt(t,n)}).then(function(){t(e,a)});break;case"get_adapter":e[1]?t(e,[this.At.adapters[e[1]].adapter]):t(e,[this.At.adapters[0].adapter]);break;case"idx.length":case"idx":var u=e[1];-1<Object.keys(this.At.tableInfo).indexOf(u)?this.At.adapters[0].adapter.getIndex(u,"idx"!==e[0],function(n){t(e,n)}):t(e,[]);break;case"rebuild_search":var c=e[1]?[e[1]]:Object.keys(i.At.tableInfo),f=e[2];s.fastALL(c,function(t,e,n){var r=0,o=0;s.fastALL(c,function(t,e,n){i.At.adapters[0].adapter.getIndex(t,!0,function(t){r+=t,n()})}).then(function(){var e=Object.keys(i.At.tableInfo[t].Pt).map(function(e){return"_"+t+"_search_tokens_"+e});e=(e=e.concat(Object.keys(i.At.tableInfo[t].Pt).map(function(e){return"_"+t+"_search_"+e}))).concat(Object.keys(i.At.tableInfo[t].Pt).map(function(e){return"_"+t+"_search_fuzzy_"+e})),s.fastALL(e,function(t,e,n){i.At.adapterDrop(t,n)}).then(function(){i.At.adapters[0].adapter.rangeRead(t,function(e,n,s){i.parent.query("upsert",e).comment("_rebuild_search_index_").manualExec({table:t}).then(function(){f&&f(Math.round((o+1)/r*1e4)/100),o++,s()})},n)})})}).then(function(){t(e,[])});break;case"rebuild_idx":e[1]?this.At.rebuildIndexes(e[1],function(n){i.At.Dt&&i.At.Ct(),t(e,[n])}):s.fastALL(Object.keys(this.At.tableInfo),function(t,e,n){i.At.rebuildIndexes(t,n)}).then(function(n){i.At.Dt&&i.At.Ct(),t(e,n)});break;default:t(e,n)}},f);function f(){this.Ft=[],this.Jt=0}e.NanoSQLDefaultBackend=c},function(t,e,n){var i=this&&this.W||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};Object.defineProperty(e,"e",{value:!0});var r=n(6),o=n(0),s=n(17),a=n(10),u={select:function(t,e,n){t.qt(e,n)},upsert:function(t,e,n){t.At.Dt?t.Qt(e,n):t.At.queue.add(t.Et.table,function(i){t.Qt(function(){i(),e(t.Et)},n)})},delete:function(t,e,n){t.At.Dt?t.Ht(e,n):t.At.queue.add(t.Et.table,function(i){t.Ht(function(){i(),e(t.Et)},n)})},drop:function(t,e,n){t.At.Dt?t.Lt(e,n):t.At.queue.add(t.Et.table,function(i){t.Lt(function(){i(),e(t.Et)},n)})},"show tables":function(t,e,n){t.Et.result=Object.keys(t.At.tableInfo),e(t.Et)},describe:function(t,e,n){"string"==typeof t.Et.table&&(t.Et.result=t.At.models[t.Et.table]?o.u(t.At.models[t.Et.table]):[{error:"Table does not exist"}]),e(t.Et)}},c=(f.prototype.doQuery=function(t,e,n){this.Et=t,this.Wt=Array.isArray(t.table),u[t.action](this,e,n)},f.prototype.$t=function(t,e){this.Wt?new y(this.Et,this.At.zt).getRows(t,e):new p(this,this.Et,this.At,function(e){t(e.filter(function(t){return t}))},e)},f.prototype.qt=function(t,e){var n=this;this.Kt=JSON.stringify(i({},this.Et,{queryID:null}));var r=!this.Et.join&&!this.Et.orm&&this.At.Dt&&!Array.isArray(this.Et.table);if(r&&this.At.Bt[this.Et.table][this.Kt]&&this.At.Bt[this.Et.table][this.Kt].time<this.At.Ut[this.Et.table])return this.Et.result=this.At.Bt[this.Et.table][this.Kt].rows,void t(this.Et);this.$t(function(i){["having","orderBy","offset","limit","actionArgs","groupBy","orm","join"].filter(function(t){return n.Et[t]}).length?new h(n.Et,n.At).Vt(i,function(e){r&&(n.At.Bt[n.Et.table][n.Kt]={rows:e,time:Date.now()}),n.Et.result=e,t(n.Et)},e):(r&&(n.At.Bt[n.Et.table][n.Kt]={rows:i,time:Date.now()}),n.Et.result=i,t(n.Et))},e)},f.prototype.Gt=function(t,e,n,i,r){var s=this;this.At.tableInfo[t.Xt].Rt,this.At.Yt(t.Xt,e,function(e){o.fastALL(e,function(e,r,a){var u=Object.isFrozen(e)?o.u(e):e;if("array"===t.Zt){u[t.tn]=u[t.tn]||[];var c=u[t.tn].indexOf(i);n?-1===c?u[t.tn].push(i):a():-1!==c?u[t.tn].splice(c,1):a(),u[t.tn].sort()}else u[t.tn]=n?i:null;s.At.zt.query("upsert",u).comment("_orm_skip").manualExec({table:t.Xt}).then(a)}).then(r)})},f.prototype.nn=function(t,e,n,i){var r=this;if(this.At.in){var s=this.At.rn[this.Et.table];if(-1===this.Et.comments.indexOf("_orm_skip"))if(s&&s.length){for(var a=Math.max(e.length,n.length),u=[];a--;)u.push(" ");o.fastCHAIN(u,function(i,a,u){o.fastALL(s,function(i,s,u){var c,f;switch(t){case"del":var h=e[a][r.At.tableInfo[r.Et.table].Rt],l="array"===i.en?e[a][i.un]||[]:[e[a][i.un]].filter(function(t){return t});r.Gt(i,l,!1,h,u);break;case"add":var p=n[a][r.At.tableInfo[r.Et.table].Rt];if(e[a])if(c=e[a][i.un],f=n[a][i.un],Array.isArray(c)&&Array.isArray(f)?c.length===f.length&&0<c.filter(function(t,e){return t!==f[e]}).length:c===f)u();else if("array"===i.en){var d=(n[a][i.un]||[]).filter(function(t){return-1===(e[a][i.un]||[]).indexOf(t)}),y=(e[a][i.un]||[]).filter(function(t){return-1===(n[a][i.un]||[]).indexOf(t)});o.fastALL([d,y],function(t,e,n){r.Gt(i,t,0===e,p,n)}).then(u)}else{function v(){null!==n[a][i.un]&&void 0!==n[a][i.un]?r.Gt(i,[n[a][i.un]],!0,p,u):u()}null!==e[a][i.un]&&void 0!==e[a][i.un]?r.Gt(i,[e[a][i.un]],!1,p,v):v()}else{var b="array"===i.en?n[a][i.un]||[]:[n[a][i.un]].filter(function(t){return t});b&&b.length?r.Gt(i,b,!0,p,u):u()}}}).then(u)}).then(i)}else i();else i()}else i()},f.prototype.sn=function(t,e){var n=this.At.tableInfo[this.Et.table].Pt[t];if(!n)return[];var i=this.At.zt.getConfig().tokenizer;if(i){var r=i(this.Et.table,t,n,e);if(!1!==r)return r}return o.tokenizer(this.Et.table,t,n,e)},f.prototype.cn=function(t,e,n){var i=this,r=this.Et.table,s=Object.keys(this.At.tableInfo[r].Pt);if(0!==s.length){var a="_"+r+"_search_tokens_";o.fastALL(s,function(n,s,u,c){var f=i.sn(n,e[n]),h={};f.forEach(function(t){h[t.w]=t.o}),i.At.adapterRead(a+n,t,function(e){e?o.fastALL(["_search_","_search_fuzzy_"],function(s,a,u,c){var f={};e.tokens.forEach(function(t){f[t.w]||(0===a&&(f[t.w]=!0),1===a&&(f[h[t.w]]=!0))}),o.fastALL(Object.keys(f),function(e,a,u,c){e?i.At.adapterRead("_"+r+s+n,e,function(a){a?(Object.isFrozen(a)&&(a=o.u(a)),a.rows=a.rows.filter(function(e){return e.id!==t}),i.At.adapterWrite("_"+r+s+n,e,a,u,c)):u()},!0):u()}).then(u).catch(c)}).then(function(){i.At.adapters[0].adapter.delete(a+n,t,u)}).catch(c):u()},!0)}).then(n)}else n()},f.prototype.an=function(t,e,n){var i=this,r=this.Et.table,s=Object.keys(this.At.tableInfo[r].Pt);if(0!==s.length&&o.intersect(Object.keys(e),s)){var a="_"+r+"_search_tokens_";o.fastALL(s,function(n,s,u,c){-1===[void 0,null,""].indexOf(e[n])?i.At.adapterRead(a+n,t,function(s){var f=s||{id:t,hash:"1505",tokens:[]},h=o.hash(e[n]);if(h!==f.hash){var l={},p=i.sn(n,e[n]),d=f.tokens.map(function(t){return t.i+"-"+t.w}).filter(function(t){return t.split("-")[1]}),y=p.map(function(t){return t.i+"-"+t.w}).filter(function(t){return t.split("-")[1]}),v=y.filter(function(t){return-1===d.indexOf(t)}),b=d.filter(function(t){return-1===y.indexOf(t)});p.forEach(function(t){l[t.w]=t.o}),o.fastCHAIN([b,v],function(e,s,a,u){var c={};e.forEach(function(t){var e=t.split(/-(.+)/),n={w:e[1],i:parseInt(e[0])};c[n.w]||(c[n.w]=[]),c[n.w].push(n)}),o.fastALL(Object.keys(c),function(e,a,u){o.fastALL(["_search_","_search_fuzzy_"],function(a,u,f,h){var d=0===u?e:l[e];d?i.At.adapterRead("_"+r+a+n,d,function(d){var y=d||{wrd:e,rows:[]};switch(Object.isFrozen(y)&&(y=o.u(y)),s){case 0:for(var v=y.rows.length;v--;)y.rows[v].id===t&&y.rows.splice(v,1);break;case 1:y.rows.push({id:t,i:c[e].map(function(t){return t.i}),l:p.length})}i.At.adapterWrite("_"+r+a+n,0===u?e:l[e],y,f,h)},!0):f()}).then(u)}).then(a)}).then(function(){i.At.adapterWrite(a+n,t,{id:t,hash:h,tokens:p.map(function(t){return{w:t.w,i:t.i}})},u,c)})}else u()},!0):u()}).then(n)}else n()},f.prototype.hn=function(t,e,n){var i=this;this.At.ln?null!=t?o.fastALL(Object.keys(this.At.tableInfo[this.Et.table].X),function(n,r,o){var s=i.At.tableInfo[i.Et.table].X[n].pkColumn;if(void 0!==t[s]){if(t[s]!==e[s])return null===t[s]?(i.At.tableInfo[i.Et.table].X[n].columns.forEach(function(e){t[e.thisColumn]=null}),void o()):void i.At.adapterRead(n,t[s],function(e){if(!e.length&&"LIVE"===i.At.tableInfo[i.Et.table].X[n].mode)return i.At.tableInfo[i.Et.table].X[n].columns.forEach(function(e){t[e.thisColumn]=null}),void o();i.At.tableInfo[i.Et.table].X[n].columns.forEach(function(n){t[n.thisColumn]=e[0][n.otherColumn]}),o()},!0);o()}else o()}).then(function(){n(t)}):n(t||{}):n(t)},f.prototype.vn=function(t,e,n){var i=this,r=this.At.tableInfo[this.Et.table].Rt;o.fastALL(t,function(t,n,s){o.fastALL(i.At.tableInfo[i.Et.table].dn,function(n,s,a){e&&"GHOST"===i.At.tableInfo[n.table].X[i.Et.table].mode?a():i.At.bn(n.table,"=",n.column,t[r],function(r){if(r.length){var s=i.At.tableInfo[n.table].X[i.Et.table].columns,u=i.At.tableInfo[n.table].X[i.Et.table].pkColumn;o.fastALL(r,function(r,o,a,c){var f=s.length,h=!1;if(e){if("LIVE"===i.At.tableInfo[n.table].X[i.Et.table].mode)for(h=!0,r[u]=null;f--;)r[s[f].otherColumn]=null}else for(;f--;)r[s[f].otherColumn]!==t[s[f].thisColumn]&&(r[s[f].otherColumn]=t[s[f].thisColumn],h=!0);if(h){var l=i.At.tableInfo[n.table].Rt;i.At.adapterWrite(n.table,r[l],r,a,c)}else a()}).then(a)}else a()})}).then(s)}).then(n)},f.prototype.pn=function(t,e,n){var i=this;this.At.ln&&this.At.tableInfo[this.Et.table].dn.length?this.vn(t,e,function(){n(i.Et)}):n(this.Et)},f.prototype.wn=function(t,e,n){var i=this;return function(r,o,s){if(t&&t[r]===e[r])s();else{function a(t){n(new Error('nSQL: Unique row violation on table "'+i.Et.table+'", row '+t[u]+" already contains value "+JSON.stringify(e[r])))}var u=i.At.tableInfo[i.Et.table].Rt;i.At.bn(i.Et.table,"=",r,e[r],function(e){if(e.length){if(!t)return void a(e[0]);e[0][u]===t[u]?s():a(e[0])}else s()})}}},f.prototype.Qt=function(t,e){var n=this,r=this.At.tableInfo[this.Et.table].Rt;if(this.Wt)this.$t(function(e){n.Et.result=n.Et.table.map(function(t){return-1===e.indexOf(t)?t:i({},n.Et.actionArgs,t)}),t(n.Et)},e);else{var s=!1;if(this.Et.where){var a=[],u=0;this.$t(function(i){if(i.length)u=i.length,n.At.Bt[n.Et.table]={},n.At.Ut[n.Et.table]=Date.now(),o.fastCHAIN(n.Et.actionArgs,function(t,c,f,h){o.fastCHAIN(i,function(i,a,u,c){var f=Object.keys(t).filter(function(t){return-1!==n.At.tableInfo[n.Et.table].yn.indexOf(t)});o.fastCHAIN(f,n.wn(i,t,e)).then(function(){n.an(i[r],i,function(){n.hn(t||{},i,function(t){n.At.tableInfo[n.Et.table]._n&&Object.keys(n.At.tableInfo[n.Et.table].mn).forEach(function(e){void 0===i[e]&&void 0===t[e]&&(t[e]=n.At.tableInfo[n.Et.table].mn[e])}),n.At.gn(n.Et.table,i[r],i,t,u,function(t){s=!0,c(t)})})})})}).then(function(t){if(!s){var e=(a=t).map(function(t){return t[r]});n.Et.result=[{msg:u+" row(s) modfied.",affectedRowPKS:e,affectedRows:a}],f()}}).catch(h)}).then(function(){s||n.nn("add",i,a,function(){n.pn(a,!1,t)})}).catch(e);else{if(s)return;n.Et.result=[{msg:"0 row(s) modfied.",affectedRowPKS:[],affectedRows:[]}],t(n.Et)}},e)}else{var c=this.Et.actionArgs||[];this.At.Ut[this.Et.table]=Date.now(),this.At.Bt[this.Et.table]={};var f=[],h=[];o.fastCHAIN(c,function(t,i,a,u){function c(i){var c=Object.keys(t).filter(function(t){return-1!==n.At.tableInfo[n.Et.table].yn.indexOf(t)});o.fastCHAIN(c,n.wn(i,t,e)).then(function(){n.hn(t,i,function(e){n.At.tableInfo[n.Et.table]._n&&Object.keys(n.At.tableInfo[n.Et.table].mn).forEach(function(t){void 0===(i||{})[t]&&void 0===e[t]&&(e[t]=n.At.tableInfo[n.Et.table].mn[t])}),n.At.gn(n.Et.table,t[r],i,e,function(t){n.an(t[r],t,function(){f.push(i||{}),h.push(t),a()})},function(t){s=!0,u(t)})})})}void 0!==t[r]&&-1===n.Et.comments.indexOf("_rebuild_search_index_")?n.At.Yt(n.Et.table,[t[r]],function(t){t.length?c(t[0]):c(null)}):c(null)}).then(function(){s||(n.Et.result=[{msg:h.length+" row(s) inserted.",affectedRowPKS:h.map(function(t){return t[r]}),affectedRows:h}],n.At.in?n.nn("add",f,h,function(){n.pn(h,!1,t)}):n.pn(h,!1,t))}).catch(e)}}},f.prototype.Ht=function(t,e){var n=this;if(this.Wt)this.Et.where?this.$t(function(e){n.Et.result=n.Et.table.filter(function(t){return-1===e.indexOf(t)}),t(n.Et)},e):(this.Et.result=[],t(this.Et));else if(this.Et.where){var i=[],r=0;this.$t(function(e){(e=e.filter(function(t){return t})).length?o.fastALL(e,function(t,e,i){n.cn(t[n.At.tableInfo[n.Et.table].Rt],t,function(){n.At.Ht(n.Et.table,t[n.At.tableInfo[n.Et.table].Rt],i)})}).then(function(o){r+=(i=e).length,n.At.Ut[n.Et.table]=Date.now(),n.At.Bt[n.Et.table]={};var s=i.map(function(t){return t[n.At.tableInfo[n.Et.table].Rt]});n.Et.result=[{msg:r+" row(s) deleted.",affectedRowPKS:s,affectedRows:i}],n.nn("del",e,[],function(){n.pn(e,!0,t)})}):(n.Et.result=[{msg:"0 row(s) deleted.",affectedRowPKS:[],affectedRows:[]}],i=[],t(n.Et))},e)}else this.Lt(t,e)},f.prototype.Lt=function(t,e){var n=this;if(this.Wt)return this.Et.result=[],void t(this.Et);this.At.On(this.Et.table,void 0,void 0,!1,function(e){n.At.Ut[n.Et.table]=Date.now(),n.At.Bt[n.Et.table]={},n.Et.table,n.At.Lt(n.Et.table,function(){n.Et.result=[{msg:"'"+n.Et.table+"' table dropped.",affectedRowPKS:e.map(function(t){return t[n.At.tableInfo[n.Et.table].Rt]}),affectedRows:e}],n.nn("del",e,[],function(){n.pn(e,!0,t)})})})},f);function f(t){this.At=t}e.xt=c;var h=(l.prototype.Sn=function(t,e,n,r){var s,a=this,u=Array.isArray(this.q.join)?this.q.join:[this.q.join];if(!u[0])return e(t),void n();var c=this.q.table,f=this.s.tableInfo[c].jn.reduce(function(t,e){return t[e]=void 0,t},{}),h=function(t,n,s){var l=u[n],p=0,d=[];if("cross"===l.type||l.table){function y(e){var n;p++,"right"!==l.type&&"outer"!==l.type||d.push(o.deepGet(g,e)),b.newItem(i({},t,((n={})[m]=e,n)))}function v(){var e,n;switch(l.type){case"left":0===p&&b.newItem(i({},t,((e={})[m]=w,e))),b.finished();break;case"inner":case"cross":b.finished();break;case"outer":case"right":0===p&&"outer"===l.type&&b.newItem(i({},t,((n={})[m]=w,n))),a.s.On(l.table,void 0,void 0,!0,function(e){e.forEach(function(e){var n;b.newItem(i({},t,((n={})[c]=f,n[m]=e,n)))}),b.finished()},function(t){return-1===d.indexOf(o.deepGet(g,t))})}}var b=new o.g(function(t,i,r,o){u[n+1]?h(t,n+1,r):(e(function(t){return Object.keys(t).reduce(function(e,n){var i=t[n];return i&&Object.keys(i).forEach(function(t){e[n+"."+t]=i[t]}),e},{})}(t)),r())},r,s),g=a.s.tableInfo[l.table].Rt,m=l.table,w=a.s.tableInfo[m].jn.reduce(function(t,e){return t[e]=void 0,t},{});if("cross"===l.type)a.s.On(l.table,void 0,void 0,!0,function(t){t.forEach(y),v()});else{var E=l.where||[];if(!E.length)return void r("No join condition!");var A=0===E[0].indexOf(l.table),O=A?E[0].split(".")[1]:E[2].split(".")[1],x=A?o.deepGet(E[2],t):o.deepGet(E[0],t);if(O===g)a.s.adapterRead(l.table,x,function(t){y(t),v()},!1);else{var k=(A?E[0]:E[2]).split(".").filter(function(t,e){return 0<e}).join(".");a.s.On(l.table,void 0,void 0,!0,function(t){t.forEach(y),v()},function(t){return o.deepGet(k,t)===x})}}}else r(new Error("Non 'cross' joins require an 'on' parameter!"))};h(((s={})[c]=t,s),0,n)},l.prototype.En=function(t,e){return t.reduce(function(t,n){return-1!==n.indexOf(".length")?t+"."+String((e[n.replace(".length","")]||[]).length):t+"."+String(e[n])},"").slice(1)},l.prototype.kn=function(t){var e=this,n=this.q.groupBy||{},i=t.sort(function(t,i){return e.Nn(t,i,n,!0)});return i.forEach(function(t,i){var r=Object.keys(n).map(function(e){return String(t[e])||""}).join(".");e.Tn||(e.Tn={}),e.Tn[r]||(e.Tn[r]=[]),e.Tn[r].push(i)}),i},l.prototype.In=function(t){var e=this;return t.filter(function(t,n){return Array.isArray(e.q.having)?b(t,e.q.having||[],n,!0):e.q.having(t,n)})},l.prototype.An=function(t){var e=this;return t.sort(function(t,n){return e.Nn(t,n,e.q.orderBy||{},!1)})},l.prototype.Mn=function(t){return t.slice(this.q.offset)},l.prototype.xn=function(t){return t.slice(0,this.q.limit)},l.prototype.Rn=function(t,e){var n=this,i=this.q.orm?this.q.orm.map(function(t){return"string"==typeof t?{key:t,limit:5}:t}):[];o.fastALL(t,function(t,e,s){t=Object.isFrozen(t)?o.u(t):t,o.fastALL(i,function(e,i,o){if(void 0!==t[e.key]){var s=n.s.Ln[n.q.table][e.key];s?n.s.zt.query("select").where([n.s.tableInfo[s.Pn].Rt,"array"===s.en?"IN":"=",t[e.key]]).manualExec({table:s.Pn}).then(function(n){var i=r.nSQL().query("select",e.select);e.where&&i.where(e.where),void 0!==e.limit&&i.limit(e.limit),void 0!==e.offset&&i.offset(e.offset),e.orderBy&&i.orderBy(e.orderBy),e.groupBy&&i.groupBy(e.groupBy),i.manualExec({table:n}).then(function(i){n.filter(function(t){return t}).length?t[e.key]="array"===s.en?i:i[0]:t[e.key]="array"===s.en?[]:void 0,o()})}):o()}else o()}).then(function(){s(t)})}).then(e)},l.prototype.Nn=function(t,e,n,i){return Object.keys(n).reduce(function(r,s){var a=i?o.objQuery(s,t):t[s],u=i?o.objQuery(s,e):e[s];return r||(a===u?0:(u<a?1:-1)*("desc"===n[s]?-1:1))},0)},l.prototype.Dn=function(t,e,n){var i=this,s=this.q.actionArgs,a={},u={},c={},f={};if(s&&s.length){var h=!1,l={},p=!1;if(s.forEach(function(t){if(-1!==t.indexOf("(")){var e=(t.match(/^.*\(/g)||[""])[0].replace(/\(|\)/g,"").toUpperCase(),i=r.NanoSQLInstance.functions[e],o=1===t.split(" AS ").length?e:(t.split(" AS ").pop()||"").trim();if(!i)return p=!0,void n(new Error("nSQL: '"+e+"' is not a valid function!"));"A"===i.type&&(h=!0),l[t]={fn:i,key:o}}}),p)return;o.fastALL(s,function(e,n,r){var s;if(-1<e.indexOf("(")){var p=(e.match(/\(.*\)/g)||[""])[0].replace(/\(|\)/g,"").split(",").map(function(t){return t.trim()});i.Tn&&h?o.fastALL(Object.keys(i.Tn),function(n,r,o){var s;c[n]||(c[n]={}),f[n]||(f[n]={}),(s=l[e].fn).call.apply(s,[t.filter(function(t,e){return-1<i.Tn[n].indexOf(e)}),function(t,i){c[n][l[e].key]=t,i&&(f[n][l[e].key]=i),o()},void 0!==i.q.join].concat(p))}).then(r):(s=l[e].fn).call.apply(s,[t,function(t,n){a[l[e].key]=t,u[l[e].key]=n,r()},void 0!==i.q.join].concat(p))}else r()}).then(function(){function n(t,e,n,r){var a={};return s.forEach(function(s){var u=-1<s.indexOf("("),c=u?l[s].fn.type:"",f=u?l[s].key:s,h=s;if(-1<s.indexOf(" AS ")){var p=s.split(" AS ");f=u?l[s].key:p[0].trim(),h=p[1]}r[f]&&Object.keys(r[f]).forEach(function(t){a[t]=r[f][t]}),a[h]=u?"A"===c?n[f]:n[f][e]:o.objQuery(f,t,void 0!==i.q.join)}),a}if(!t.length&&h){var r=[{}];return Object.keys(l).forEach(function(t){void 0!==a[l[t].key]&&(r[0][t]=a[l[t].key])}),void e(r)}if(i.Tn&&h){var p=[];Object.keys(i.Tn).forEach(function(e){var r=t.filter(function(t,n){return-1<i.Tn[e].indexOf(n)}).filter(function(t,e){return e<1});r&&r.length&&p.push(n(r[0],0,c[e],f[e]))}),e(p)}else e(h?t.filter(function(t,e){return e<1}).map(function(t,e){return n(t,e,a,u)}):t.map(function(t,e){return n(t,e,a,u)}))})}else e(t)},l.prototype.Vt=function(t,e,n){function i(){a.q.having&&(t=a.In(t)),a.q.orderBy&&(t=a.An(t)),a.q.offset&&(t=a.Mn(t)),a.q.limit&&(t=a.xn(t)),e(t)}function r(){a.q.actionArgs&&a.q.actionArgs.length?a.Dn(t,function(e){t=e,i()},n):i()}function s(){a.q.groupBy&&(t=a.kn(t)),a.q.orm?a.Rn(t,function(e){t=e,r()}):r()}var a=this;if(this.q.join){var u=[];console.log(t),o.fastCHAIN(t,function(t,e,i){a.Sn(t,function(t){u.push(t)},i,n)}).then(function(){t=u,s()}).catch(n)}else s()},l);function l(t,e){this.q=t,this.s=e,this.Cn=[]}e.Fn=h;var p=(d.prototype.Jn=function(t,e){var n=this;if(t&&"string"==typeof t[0])this.qn(t,e);else if(t){var i=[],r="",s=this.s.tableInfo[this.q.table].Rt;o.fastCHAIN(t,function(t,e,o){if(e%2==1)return r=t,void o();n.qn(t,function(t){if("AND"===r){for(var e={},n=t.length;n--;)e[t[n][s]]=!0;i=i.filter(function(t){return e[t[s]]})}else i=i.concat(t);o()})}).then(function(){var t={};e(i.filter(function(e){return!t[e[s]]&&(t[e[s]]=!0)}))})}},d.prototype.qn=function(t,e){var n=this;if(0!==t[0].indexOf("search("))if(0!==t[0].indexOf("crow("))if("BETWEEN"!==t[1]){var u=[],c="";switch(t[1]){case"IN":if(u=t[2],!Array.isArray(u))throw new Error("nSQL: IN query must use array!");c="=";break;case"=":case">":case">=":case"<":case"<=":u=[t[2]],c=t[1]}t[0]===this.s.tableInfo[this.q.table].Rt?"="===c?this.s.Yt(this.q.table,u,e):this.s.adapters[0].adapter.getIndex(this.q.table,!1,function(t){var i=u[0],r=t.filter(function(t){switch(c){case">":return i<t;case">=":return i<=t;case"<":return t<i;case"<=":return t<=i}return!1});r.length?n.s.Yt(n.q.table,r,e):e([])}):o.fastALL(u,function(e,i,r){n.s.bn(n.q.table,c,t[0],e,r)}).then(function(t){e([].concat.apply([],t))})}else{var f=t[0]===this.s.tableInfo[this.q.table].Rt?"":t[0];if(!Array.isArray(t[2]))throw new Error("nSQL: BETWEEN query must use an array!");if(f){var h="_"+this.q.table+"_idx_"+f;if(this.s.Dt){var l=this.s.Qn[h].idx.filter(function(e){return t[2][0]<=e&&t[2][1]>=e}).map(function(t){return n.s.Qn[h].rows[t]}).reverse().reduce(function(t,e){return t.concat(e.rows)},[]);this.s.Yt(this.q.table,l,e)}else this.s.On(h,t[2][0],t[2][1],!0,function(t){for(var i=[],r=t.length;r--;)i=i.concat(t[r].rows);n.s.Yt(n.q.table,i,e)})}else this.s.On(this.q.table,t[2][0],t[2][1],!0,function(t){e(t)})}else{var p=t[0].replace(/crow\((.*)\)/gim,"$1").split(",").map(function(t,e){return e<2?parseFloat(t.trim()):t.trim()}),d="_"+this.q.table+"_idx_"+(2<p.length?p[2]:"lat"),y="_"+this.q.table+"_idx_"+(2<p.length?p[3]:"lon"),v=parseFloat(t[2]||"0"),b=[-1,1].map(function(t){return p[0]+v*t/r.NanoSQLInstance.earthRadius*(180*Math.PI)}),g=[-1,1].map(function(t){return p[1]+v*t/r.NanoSQLInstance.earthRadius*(180*Math.PI)/Math.cos(p[0]*Math.PI/180)});o.fastALL([d,y],function(t,e,i){var r=0===e?b:g;n.s.On(t,r[0],r[1],!0,i)}).then(function(t){if(t[0].length&&t[1].length){var s={},a=[];[0,1].forEach(function(e){t[e].forEach(function(t){t.rows.forEach(function(n){switch(e){case 0:s[n]=t.id;break;case 1:s[n]&&o.crowDistance(p[0],p[1],s[n],t.id,r.NanoSQLInstance.earthRadius)<v&&a.push(n)}})})});var u=n.qu.At.tableInfo[n.q.table].Rt;n.s.Yt(n.q.table,a,function(t){e(t.map(function(t){return i({},t,{Hn:s[t[u]]})}))})}else e([])})}else{var m=0;-1!==t[1].indexOf(">")?m=parseFloat(t[1].replace(">",""))+1e-4:-1!==t[1].indexOf("<")&&(m=-1*parseFloat(t[1].replace("<",""))+1e-4);var w=t[0].replace(/search\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}),E={},A={};o.fastALL(w,function(e,i,r){var u=n.qu.sn(e,t[2]),c=n.s.tableInfo[n.q.table].Pt[e],f={},h=[],l={},p={};u.forEach(function(t){l[t.w]=t.o,p[t.o]=t.w}),o.fastALL(["_search_","_search_fuzzy_"],function(t,i,r){var a="_"+n.q.table+t+e;switch(i){case 0:o.fastALL(u,function(t,e,i){n.s.adapterRead(a,t.w,function(e){e&&e.rows.forEach(function(e){f[e.id]||(f[e.id]={}),h.push(e.i[0]),f[e.id][t.w]=e}),i()})}).then(r);break;case 1:if(0===m)return void r();n.s.adapters[0].adapter.getIndex(a,!1,function(t){var e=[];t.forEach(function(t){u.forEach(function(n){s(n.o,t)&&(A[n.o]=t,l[t]=n.o,e.push(t))})}),e=e.filter(function(t,e,n){return n.indexOf(t)===e}),o.fastALL(e,function(t,e,i){n.s.adapterRead(a,t,function(e){e&&e.rows.forEach(function(e){var n=!1;if(f[e.id]?-1!==h.indexOf(e.i[0])&&(n=!0):f[e.id]={},!n){var i=p[t]||t;f[e.id][i]=e}}),i()})}).then(r)})}}).then(function(){Object.keys(f).forEach(function(t){if(0!==m||Object.keys(f[t]).length===u.length){E[t]||(E[t]={weight:0,locations:{}});var n=0,i=Object.keys(f[t]).map(function(e){return n=f[t][e].l,l[e]&&(E[t].weight+=5),{word:l[e]||e,loc:f[t][e].i}}),r=i.reduce(function(t,e){return t+e.loc.length},0);if(E[t].weight+=r/n+parseInt(c[0]),E[t].locations[e]=i,0!==m)u.forEach(function(e){var n=f[t][e.w];n&&n.i.forEach(function(n){Object.keys(f[t]).forEach(function(i){i!==e.w&&f[t][i].i.forEach(function(e){var i=Math.abs(e-n);i&&(E[t].weight+=10/(10*i))})})}),A[e.o]&&i.forEach(function(n){if(A[e.o]===n.word){var i=a(e.o,n.word);E[t].weight+=i<=1?10:10/(5*i)}})});else if(1<u.length){var o=[];Object.keys(f[t]).forEach(function(e){e===u[0].w&&(o=f[t][e].i)});var s=!0;o.forEach(function(e,n){var i=u[n+1];i&&Object.keys(f[t]).forEach(function(n){if(n===i.w){var r=i.i+e;-1===f[t][n].i.indexOf(r)&&(s=!1)}})}),s||delete E[t]}}else delete f[t]}),r()})}).then(function(t){for(var r=0,s=Object.keys(E),u=s.length;u--;)r=Math.max(r,E[s[u]].weight);for(u=s.length;u--;)E[s[u]].weight=E[s[u]].weight/r;o.fastALL(s.filter(function(t){return 0===m||(0<m?m<E[t].weight:!(m<0)||-1*m>E[t].weight)}),function(t,e,i){n.s.adapterRead(n.q.table,t,i)}).then(function(t){var r=n.s.tableInfo[n.q.table].Rt;(t=t.filter(function(t){return t})).forEach(function(t){var e=t[r];Object.keys(E[e].locations).forEach(function(i){var r=n.qu.sn(i,t[i]).map(function(t){return t.o});E[e].locations[i].forEach(function(t){t.loc.forEach(function(n){var i=a(r[n],t.word);E[e].weight+=i<=1?10:10/(10*i)})})})});for(var o=0,s=Object.keys(E),u=s.length;u--;)o=Math.max(o,E[s[u]].weight);for(u=s.length;u--;)E[s[u]].weight=E[s[u]].weight/o;e(t.filter(function(t){return 0===m||(0<m?m<E[t[r]].weight:!(m<0)||-1*m>E[t[r]].weight)}).map(function(t){return i({},t,{Wn:E[t[r]].weight,$n:E[t[r]].locations})}))})})}},d.prototype.zn=function(t){var e=this;if(this.q.range){var n=this.q.range;0<n[0]?this.s.On(this.q.table,n[1],n[1]+n[0]-1,!1,t):this.s.adapters[0].adapter.getIndex(this.q.table,!0,function(i){for(var r=i+n[0]-n[1],o=r,s=Math.abs(n[0])-1;s--;)o++;e.s.On(e.q.table,r,o,!1,t)})}else t([])},d.prototype.Kn=function(t){this.q.trie?this.s.Bn(this.q.table,this.q.trie.column,this.q.trie.search,t):t([])},d.prototype.Un=function(t){function e(){n.s.Yt(n.q.table,function(t,e,o){o(!i||(r?b(t,n.q.where,e,!1,a,s):n.q.where(t,e)))},t)}var n=this,i=void 0!==this.q.where,r=i&&Array.isArray(this.q.where),s=this.s.tableInfo[this.q.table].Rt,a=[],u=this.q.where||[];r&&"string"!=typeof u[0]?o.fastCHAIN(u,function(t,e,i){-1!==t[0].indexOf("search(")?n.qu.At.zt.query("select").where(t).manualExec({table:n.q.table}).then(function(t){a[e]=t.map(function(t){return t[s]}),i()}):i()}).then(function(){e()}):e()},d.prototype.Vn=function(t){var e=this;if("string"==typeof t[0])return 0;if(0!==this.Gn(t[0]))return 0;var n=0;return t.forEach(function(i,r){r%2==0&&0===e.Gn(i)&&t[r+1]&&(n=r+1)}),"AND"!==t[n]?0:n},d.prototype.Gn=function(t){var e=this.s.tableInfo[this.q.table],n=t[0]||"",i=t[1]||"";if(Array.isArray(n))return 1;if(1===n.indexOf("crow(")||"<"!==i)return-1===n.indexOf("search(")||-3===["=",">","<"].reduce(function(e,n){return e+t[1].indexOf(n)},0)?(n===e.Rt||-1!==e.Qn.indexOf(n))&&-1<["=","IN","BETWEEN",">",">=","<","<="].indexOf(t[1])?0:1:n.replace(/search\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}).filter(function(t){return-1!==Object.keys(e.Pt).indexOf(t)}).length?0:1;var r=n.replace(/crow\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}),o=r[2]||"lat",s=r[3]||"lon";return-1===e.Qn.indexOf(o)||-1===e.Qn.indexOf(s)?1:0},d);function d(t,e,n,i,r){var o=this;if(this.qu=t,this.q=e,this.s=n,this.q.join&&this.q.orm&&r(new Error("nSQL: Cannot do a JOIN and ORM command at the same time!")),1<[this.q.where,this.q.range,this.q.trie].filter(function(t){return t}).length&&r(new Error("nSQL: Can only have ONE of Trie, Range or Where!")),this.q.trie&&this.q.trie.column&&this.q.trie.search)this.Kn(i);else if(this.q.range&&this.q.range.length)this.zn(i);else if(this.q.where&&this.q.where.length&&Array.isArray(this.q.where))if("string"==typeof this.q.where[0]?0===this.Gn(this.q.where):0===(this.q.where||[]).reduce(function(t,e,n){return n%2==1?t:t+o.Gn(e)},0))this.Jn(this.q.where,i);else{var s=this.Vn(this.q.where);if(0<s){var a=this.q.where.slice(0,s),u=this.q.where.slice(s+1);this.Jn(a,function(t){i(t.filter(function(t,e){return b(t,u,e,!1)}))})}else this.Un(i)}else this.Un(i)}e.Xn=p;var y=(v.prototype.getRows=function(t,e){var n=this;if(this.q.join||this.q.orm||this.q.trie)e(new Error("nSQL: Cannot do a JOIN, ORM or TRIE command with instance table!"));else if(this.q.range&&this.q.range.length){var i,r,o=this.q.range;i=o[0]<0?this.q.table.length+o[0]-o[1]:o[1];var s=Math.abs(o[0])-1;for(r=i;s--;)r++;t(this.q.table.filter(function(t,e){return i<=e&&e<=r}))}else t(this.q.table.filter(function(t,e){return!n.q.where||(Array.isArray(n.q.where)?b(t,n.q.where||[],e,!1):n.q.where(t,e))}))},v);function v(t,e){this.q=t,this.p=e}e.InstanceSelection=y;var b=function(t,e,n,i,r,o){if("string"==typeof e[0])return w(e,t,i||!1);var s,a,u=-1!==e.indexOf("OR");return e.reduce(function(e,c,f){if(void 0!==s)return s;if(f%2==1)return a=c,e;var h;return h=0===c[0].indexOf("search(")&&r?-1!==r[f].indexOf(t[o]):Array.isArray(c[0])?b(t,c,n,i||!1,r,o):w(c,t,i||!1),u||!1!==h?0===f?h:"AND"===a?e&&h:e||h:s=!1},!1)},g={},m={},w=function(t,e,n){function i(t,e){if(!g[e]){var n="";g[e]=new RegExp(e.split("").map(function(t){return"\\"===n?n=t:"%"===(n=t)?".*":"_"===t?".":t}).join(""),"gmi")}return"string"!=typeof t?"number"==typeof t?null!==String(t).match(g[e]):null!==JSON.stringify(t).match(g[e]):null!==t.match(g[e])}m[t[0]]||(m[t[0]]=-1!==t[0].indexOf("(")?t[0].replace(/(.*)\((.*)\)/gim,"$1,$2").split(",").map(function(t){return isNaN(t)?t.trim():parseFloat(t.trim())}):[]);var s=t[2],a=t[1],u=function(){if(m[t[0]].length){var i=r.NanoSQLInstance.whereFunctions[m[t[0]][0]];return i?i.apply(null,[e,n].concat(m[t[0]].slice(1))):void 0}return o.objQuery(t[0],e,n)}();if("NULL"===s||"NOT NULL"===s){var c=-1!==[void 0,null,""].indexOf(u),f="="===a||"LIKE"===a;switch(s){case"NULL":return f?c:!c;case"NOT NULL":return f?!c:c}}if(-1!==["IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(a)&&!Array.isArray(s))throw new Error("nSQL: "+a+" requires an array value!");switch(a){case"=":return u===s;case"!=":return u!==s;case">":return s<u;case"<":return u<s;case"<=":return u<=s;case">=":return s<=u;case"IN":return-1!==(s||[]).indexOf(u);case"NOT IN":return-1===(s||[]).indexOf(u);case"REGEXP":case"REGEX":return null!==(u||"").match(s);case"LIKE":return i(u||"",s);case"NOT LIKE":return!i(u||"",s);case"BETWEEN":return s[0]<=u&&s[1]>=u;case"HAVE":case"INCLUDES":return-1!==(u||[]).indexOf(s);case"NOT HAVE":case"NOT INCLUDES":return-1===(u||[]).indexOf(s);case"INTERSECT":return 0<(u||[]).filter(function(t){return-1<(s||[]).indexOf(t)}).length;case"INTERSECT ALL":return(u||[]).filter(function(t){return-1<(s||[]).indexOf(t)}).length===s.length;case"NOT INTERSECT":return 0===(u||[]).filter(function(t){return-1<(s||[]).indexOf(t)}).length;default:return!1}}},function(t,e,n){"use strict";t.exports=function(t,e){var n=e.length,i=t.length;if(n<i)return!1;if(i===n)return t===e;t:for(var r=0,o=0;r<i;r++){for(var s=t.charCodeAt(r);o<n;)if(e.charCodeAt(o++)===s)continue t;return!1}return!0}},function(t,e,n){var i=this&&this.W||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};Object.defineProperty(e,"e",{value:!0});var r=n(19),o=n(0),s=n(7),a=n(8),u=n(9),c=n(1),f=n(20),h=(l.prototype.Ct=function(){var t=this;if(this.Dt&&!this.Yn&&Object.keys(this.Zn).length){this.Yn=!0;var e=o.u(this.Zn);this.Zn={},o.fastALL(Object.keys(e),function(n,i,r){var s=e[n];o.fastALL(s,function(e,i,r){t.adapterWrite(n,e,o.u(t.Qn[n].rows[e]),r,function(t){})}).then(r)}).then(function(){setTimeout(function(){t.Yn=!1,t.Ct()},100)})}},l.prototype.init=function(t,e){var n=this;this.at||(this.at=o.hash(JSON.stringify(t)).toString()),this.models=this.ti(t),this.ni=Object.keys(this.models),this.adapters.forEach(function(t){t.adapter.setID(n.at)}),this.ni.forEach(function(e){n.ii(e,t[e])}),this.ri={},this.rn={},this.ei={},this.Ln={},this.ni.forEach(function(t){n.tableInfo[t].dn=Object.keys(n.tableInfo).reduce(function(e,i){return i===t||-1!==Object.keys(n.tableInfo[i].X).indexOf(t)&&e.push({table:i,column:n.tableInfo[i].X[t].pkColumn}),e},[]);var e=n.models[t].length;function i(){var i=n.models[t][e];if(-1!==n.ni.indexOf(i.type.replace("[]",""))){var r="";n.Ln[t][i.key]={Pn:i.type.replace("[]",""),en:-1===i.type.indexOf("[]")?"single":"array"},i.props&&(i.props.forEach(function(t){-1!==t.indexOf("ref=>")&&(r=t.replace("ref=>","")),0===t.indexOf("orm(")&&(r=t.replace(/orm\((.*)\)/gim,"$1"))}),r&&(n.in=!0,n.ei[t].push(i.key),n.ri[t][i.key]={Pn:i.type.replace("[]",""),oi:r.replace("[]",""),ui:-1===r.indexOf("[]")?"single":"array",en:-1===i.type.indexOf("[]")?"single":"array"}))}}for(n.ri[t]={},n.ei[t]=[],n.rn[t]=[],n.Ln[t]={};e--;)i()}),Object.keys(this.ri).forEach(function(t){Object.keys(n.ri[t]).forEach(function(e){var i=n.ri[t][e];n.rn[i.Pn].push({un:i.oi,en:i.ui,Xt:t,tn:e,Zt:i.en})})}),o.fastALL(this.adapters,function(t,e,i){t.adapter.connect(function(){t.adapter.setNSQL&&t.adapter.setNSQL(n.zt),i()})}).then(function(){o.fastALL(Object.keys(n.si),function(t,e,i){var r=n.si[t];Object.keys(r).length?o.fastALL(Object.keys(r),function(e,i,r){var o="_"+t+"_idx_"+e;n.adapters[0].adapter.getIndex(o,!1,function(i){i.forEach(function(i){n.si[t][e].addWord(String(i))}),r()})}).then(i):i()}).then(function(){n.Dt?o.fastALL(Object.keys(n.tableInfo),function(t,e,i){o.fastALL(n.tableInfo[t].Qn,function(e,i,r){var o="_"+t+"_idx_"+e;n.adapters[0].adapter.getIndex(o,!1,function(t){n.Qn[o].idx=t,n.adapters[0].adapter.rangeRead(o,function(t,e,i){n.Qn[o].rows[t.id]=t,i()},r)})}).then(i)}).then(function(){e(n.models)}):e(n.models)})})},l.prototype.rebuildIndexes=function(t,e){var n=this,i=(new Date).getTime();o.fastALL(Object.keys(this.tableInfo),function(e,i,r,s){if("_ALL_"!==t&&t!==e||0===e.indexOf("_"))r();else{var a=n.tableInfo[e].Qn;o.fastALL(a,function(t,i,r){var o="_"+e+"_idx_"+t;n.Qn[o].idx=[],n.Qn[o].rows={},n.Zn[o]=[],n.Lt(o,r)}).then(function(){var t=n.tableInfo[e].Rt,i={};a.forEach(function(t){i[t]={}}),n.Yt(e,function(e,n,r){e[t]&&a.forEach(function(n){e[n]&&(i[n][e[n]]||(i[n][e[n]]=[]),i[n][e[n]].push(e[t]))}),r(!1)},function(){o.fastALL(a,function(t,r,a){var u="_"+e+"_idx_"+t;n.Dt?(Object.keys(i[t]).forEach(function(e,r){n.Zn[u].push(e),n.Qn[u].idx.push(e),n.Qn[u].rows[e]={id:e,rows:i[t][e]}}),a()):o.fastALL(Object.keys(i[t]),function(e,r,o,s){e?n.adapterWrite(u,e,{id:e,rows:i[t][e].sort()},o,s):o()}).then(a).catch(s)}).then(function(){r()}).catch(s)})})}}).then(function(){e((new Date).getTime()-i)})},l.prototype.ci=function(t){return o.isObject(t)||Array.isArray(t)?JSON.stringify(t):"number"==typeof t?t:String(t)},l.prototype.fi=function(){return"undefined"==typeof window?"LVL":o.isSafari?"WSQL":"undefined"!=typeof indexedDB?"IDB":"undefined"!=typeof window&&void 0!==window.openDatabase?"WSQL":"LS"},l.prototype.bn=function(t,e,n,i,r){function o(t,e,n){u.Dt?n(e.map(function(e){return u.Qn[t].rows[e]}).filter(function(t){return t})):1===e.length?u.adapters[0].adapter.read(t,e[0],function(t){n([t])}):u.Yt(t,e,function(t){n(t)})}var s,a,u=this;switch(e){case"=":o("_"+t+"_idx_"+n,[this.ci(i)],function(e){void 0!==e[0]&&null!==e[0]?u.Yt(t,e[0].rows||[],function(t){r(t)}):r([])});break;default:s="_"+t+"_idx_"+n,a=function(s){var a=u.ci(i),c=s.filter(function(t){switch(e){case">":return a<t;case">=":return a<=t;case"<":return t<a;case"<=":return t<=a}return!1});c.length?o("_"+t+"_idx_"+n,c,function(e){var n=[].concat.apply([],e.map(function(t){return t.rows}));n.length?u.Yt(t,n,function(t){r(t)}):r([])}):r([])},u.Dt?a(u.Qn[s].idx):u.adapters[0].adapter.getIndex(s,!1,a)}},l.prototype.On=function(t,e,n,i,r,o){var s=[];this.adapters[0].adapter.rangeRead(t,function(t,e,n){o?o(t)&&s.push(t):s.push(t),n()},function(){r(s)},e,n,i)},l.prototype.Yt=function(t,e,n){var i=this;if(Array.isArray(e)){var r=this.adapters[0].adapter.batchRead;r?r.apply(this.adapters[0].adapter,[t,e,n]):o.fastALL(e,function(e,n,r){i.adapters[0].adapter.read(t,e,r)}).then(function(t){n(t.filter(function(t){return t}))})}else{var s=[];"function"!=typeof e||this.adapters[0].adapter.rangeRead(t,function(t,n,i){e(t,n,function(e){e&&s.push(t),n%200==0?c.setFast(i):i()})},function(){n(s)})}},l.prototype.Bn=function(t,e,n,i){var r=this,s=this.si[t][e].getPrefix(n);o.fastALL(s,function(n,i,o){r.bn(t,"=",e,n,o)}).then(function(t){i([].concat.apply([],t))})},l.prototype.hi=function(t,e,n,i,r){var s=this;this.Dt?(i.forEach(function(i){var r="_"+t+"_idx_"+i,o=s.ci(n[i]);s.Zn[r]||(s.Zn[r]=[]),-1===s.Zn[r].indexOf(o)&&s.Zn[r].push(o);var a=s.Qn[r].rows[o];if(a){var u=a.rows.indexOf(e);if(-1!==u){var c=a||{id:o,rows:[]};c.rows.splice(u,1),s.Qn[r].rows[o]=c}}}),this.Ct(),r()):o.fastALL(i,function(i,r,a,u){var c=s.ci(n[i]),f="_"+t+"_idx_"+i;s.adapters[0].adapter.read(f,c,function(t){if(t){var n=t.rows.indexOf(e);if(-1!==n){var i=t?Object.isFrozen(t)?o.u(t):t:{id:c,rows:[]};i.rows.splice(n,1),s.adapterWrite(f,i.id,i,a,u)}else a()}else a()})}).then(r)},l.prototype.li=function(t,e,n,i,r){var s=this;this.Dt?(i.forEach(function(i,r){var a=s.ci(n[i]);if(void 0!==a&&("string"!=typeof a||a.length)){s.si[t][i]&&s.si[t][i].addWord(String(n[i]));var u="_"+t+"_idx_"+i;s.Zn[u]||(s.Zn[u]=[]),-1===s.Zn[u].indexOf(a)&&s.Zn[u].push(a);var c=s.Qn[u].rows[a];if(!c)if(c={id:a,rows:[]},s.Qn[u].sortIdx){var f=o.binarySearch(s.Qn[u].idx,a);s.Qn[u].idx.splice(f,0,a)}else s.Qn[u].idx.push(a);c.rows.push(e),s.Qn[u].rows[a]=c}}),this.Ct(),r&&r()):o.fastALL(i,function(i,r,a,u){var c=s.ci(n[i]);if(void 0!==c)if("string"!=typeof c||c.length){s.si[t][i]&&s.si[t][i].addWord(String(n[i]));var f="_"+t+"_idx_"+i;s.adapters[0].adapter.read(f,c,function(t){var n=t?Object.isFrozen(t)?o.u(t):t:{id:c,rows:[]};n.rows.push(e),c?s.adapterWrite(f,c,n,a,u):a()})}else a();else a()}).then(function(){r&&r()})},l.prototype.gn=function(t,e,n,r,s,a){var u,c=this;if(n){var f=i({},n,r,((u={})[this.tableInfo[t].Rt]=e,u)),h=this.tableInfo[t].Qn.filter(function(t){return-1===Object.keys(f).filter(function(t){return f[t]===n[t]}).indexOf(t)});this.tableInfo[t].Qn.length?o.fastALL([0,1,2],function(i,r,o,s){switch(i){case 0:c.hi(t,e,n,h,o);break;case 1:c.li(t,e,f,h,o);break;case 2:c.adapterWrite(t,e,f,o,s)}}).then(function(t){s(t[2])}).catch(a):this.adapterWrite(t,e,f,function(t){s(t)},a)}else this.adapterWrite(t,e,r,function(e){c.tableInfo[t].Qn.length?c.li(t,e[c.tableInfo[t].Rt],r,c.tableInfo[t].Qn,function(){s(e)}):s(e)},a)},l.prototype.Ht=function(t,e,n){var i=this;if(!e)throw new Error("nSQL: Can't delete without a primary key!");this.adapters[0].adapter.read(t,e,function(r){o.fastALL([0,1],function(n,o,s){switch(n){case 0:i.hi(t,e,r,i.tableInfo[t].Qn,s);break;case 1:i.adapterDelete(t,e,s)}}).then(function(){n(r)})})},l.prototype.Lt=function(t,e){var n=this,i=Object.keys(this.tableInfo[t].Pt).map(function(e){return"_"+t+"_search_tokens_"+e});i=(i=i.concat(Object.keys(this.tableInfo[t].Pt).map(function(e){return"_"+t+"_search_"+e}))).concat(Object.keys(this.tableInfo[t].Pt).map(function(e){return"_"+t+"_search_fuzzy_"+e}));var s=this.tableInfo[t].Qn.map(function(e){return"_"+t+"_idx_"+e});i=i.concat(s),this.Dt&&s.forEach(function(t){n.Qn[t].idx=[],n.Qn[t].rows={}}),o.fastALL(i,function(t,e,i){n.adapterDrop(t,i)}).then(function(){n.si[t]={},n.tableInfo[t].vi.forEach(function(e){n.si[t][e]=new r.Trie([])}),n.adapterDrop(t,e)})},l.prototype.ti=function(t){return Object.keys(t).forEach(function(e){var n=!1,i=!1,r="";if(t[e].forEach(function(s){if(s.props&&s.props.length){if(o.intersect(["pk","pk()"],s.props)&&(r=s.key),o.intersect(["trie","idx","idx()","trie()","unique()","unique"],s.props)){n=!0;var a=-1!==["number","float","int"].indexOf(s.type);t["_"+e+"_idx_"+s.key]=[{key:"id",type:a?s.type:"string",props:["pk()"]},{key:"rows",type:"any[]"}]}s.props.forEach(function(n){-1!==n.indexOf("search(")&&(i=!0,t["_"+e+"_search_"+s.key]=[{key:"wrd",type:"string",props:["pk()","ns()"]},{key:"rows",type:"any[]"}],t["_"+e+"_search_fuzzy_"+s.key]=[{key:"wrd",type:"string",props:["pk()","ns()"]},{key:"rows",type:"any[]"}],t["_"+e+"_search_tokens_"+s.key]=[{key:"id",type:r,props:["pk()","ns()"]},{key:"hash",type:"string"},{key:"tokens",type:"any[]"}])})}}),(n||i)&&!r)throw new Error("nSQL: Tables with secondary indexes or search() must have a primary key!")}),t},l.prototype.ii=function(t,e){var n=this;function i(){var e=a.models[t][s];if(a.tableInfo[t].jn.unshift(e.key),void 0!==e.default&&(a.tableInfo[t].mn[e.key]=e.default,a.tableInfo[t]._n=!0),e.props&&e.props.length){var i=!1;e.props.forEach(function(r){if(-1!==r.indexOf("from=>")){n.ln=!0;var o=e.type;"from=>GHOST"!==r&&"from=>LIVE"!==r&&(o=r.replace("from=>","").split(".").shift()),n.tableInfo[t].X[o]||(n.tableInfo[t].X[o]={pkColumn:"",mode:"",columns:[]}),"from=>GHOST"===r||"from=>LIVE"===r?(i=!0,n.tableInfo[t].X[o].pkColumn=e.key,n.tableInfo[t].X[o].mode=r.replace("from=>","")):n.tableInfo[t].X[o].columns.push({thisColumn:e.key,otherColumn:r.replace("from=>","").split(".").pop()})}0===r.indexOf("search(")&&(n.tableInfo[t].Pt[e.key]=r.replace(/search\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}))});var u=!1;o.intersect(["pk","pk()"],e.props)&&(u=!0,a.tableInfo[t].Rt=e.key,a.tableInfo[t].di=e.type),o.intersect(["unique()","unique"],e.props)&&!u&&(i=!0,a.tableInfo[t].yn.push(e.key)),(o.intersect(["trie","idx","idx()","trie()"],e.props)||i)&&!1===u&&(a.tableInfo[t].Qn.push(e.key),a.Qn["_"+t+"_idx_"+e.key]={idx:[],rows:[],sortIdx:-1!==["number","int","float"].indexOf(e.type)}),o.intersect(["trie","trie()"],e.props)&&!1===u&&(a.tableInfo[t].vi.push(e.key),a.si[t][e.key]=new r.Trie([]))}}this.tableInfo[t]={Rt:"",di:"",jn:[],mn:[],Qn:[],_n:!1,vi:[],bi:t,X:{},dn:[],Pt:{},yn:[]},this.Bt[t]={},this.Ut[t]=Date.now(),this.si[t]={},this.adapters.forEach(function(n){n.adapter.makeTable(t,e)});for(var s=this.models[t].length,a=this;s--;)i();return t},l.prototype.adapterRead=function(t,e,n,i){this.adapters[0].adapter.read(t,e,function(t){n(t)})},l.prototype.adapterWrite=function(t,e,n,i,r){var s;o.fastCHAIN(this.adapters,function(i,r,o,a){i.waitForWrites?i.adapter.write(t,e,n,function(t){s=t,o()},a):(o(),i.adapter.write(t,e,n,function(t){},a))}).then(function(){i(s)}).catch(r)},l.prototype.adapterDelete=function(t,e,n,i){o.fastALL(this.adapters,function(n,i,r){n.waitForWrites?n.adapter.delete(t,e,function(){r()}):(r(),n.adapter.delete(t,e,function(){}))}).then(function(){n()}).catch(function(t){i&&i(t)})},l.prototype.adapterDrop=function(t,e,n){o.fastALL(this.adapters,function(e,n,i){e.waitForWrites?e.adapter.drop(t,function(){i()}):(i(),e.adapter.drop(t,function(){}))}).then(function(){e()}).catch(function(t){n&&n(t)})},l);function l(t,e){var n=this;if(this.ni=[],this.Qn={},this.Zn={},this.zt=t,this.pi=e.persistent?"PERM":e.mode||"TEMP",this.at=e.id,this.mt=e.size||5,this.queue=function(t){return{qs:{},add:function(e,n){t.queue.qs[e]||(t.queue.qs[e]=f({autostart:!0,concurrency:1})),t.queue.qs[e].push(function(t){c.setFast(function(){return n(t)})})}}}(this),this.adapters=[],this.models={},this.tableInfo={},this.si={},this.ni=[],this.Dt=void 0===e.cache||e.cache,this.Bt={},this.Ut={},this.Dt&&e.peer&&"undefined"!=typeof window){var i=t.sTable;t.table("*").on("peer-change",function(t){n.Bt[t.table]={},n.Ut[t.table]=Date.now()}),t.table(i)}if(this.adapters[0]={adapter:null,waitForWrites:!0},"string"==typeof this.pi)switch("PERM"===this.pi&&(this.pi=this.fi()||this.pi),this.pi){case"IDB":case"IDB_WW":this.adapters[0].adapter=new a._t(e.idbVersion||e.version);break;case"WSQL":this.adapters[0].adapter=new u.jt(this.mt);break;case"LS":this.adapters[0].adapter=new s.bt(!0);break;case"TEMP":this.adapters[0].adapter=new s.bt(!1)}else this.adapters[0].adapter=this.pi}e.Mt=h},function(t,e){Object.defineProperty(e,"e",{value:!0});var n=(i.prototype.getIndex=function(){return this.wi},i.prototype.setIndex=function(t){this.wi=t},i.prototype.addWord=function(t){return t.toLowerCase().split("").reduce(function(t,e,n,r){return i.yi(t,e,n,r)},this.wi),this},i.prototype.removeWord=function(t){var e=i._i(this.wi,t),n=e.prefixFound,r=e.prefixNode;return n&&delete r.$,this},i.prototype.getWords=function(){return i.mi(this.wi,"")},i.prototype.getPrefix=function(t){if(t=t.toLowerCase(),!this.gi(t))return[];var e=i._i(this.wi,t).prefixNode;return i.mi(e,t)},i.prototype.gi=function(t){return i._i(this.wi,t).prefixFound},i.yi=function(t,e,n,i){return t[e]=t[e]||{},t=t[e],n===i.length-1&&(t.$=1),t},i._i=function(t,e){return{prefixFound:e.toLowerCase().split("").every(function(e,n){return!!t[e]&&(t=t[e])}),prefixNode:t}},i.Oi=function(t){return(t||[]).reduce(function(t,e){return e.toLowerCase().split("").reduce(i.yi,t),t},{})},i.mi=function(t,e,n){void 0===n&&(n=[]);var r=e;for(var o in t)"$"===o&&(n.push(r),r=""),i.mi(t[o],e+o,n);return n.sort()},i);function i(t){this.wi=i.Oi(t)}e.Trie=n},function(t,e,n){var i=n(21),r=n(22).EventEmitter;function o(t){if(!(this instanceof o))return new o(t);r.call(this),t=t||{},this.concurrency=t.concurrency||1/0,this.timeout=t.timeout||0,this.autostart=t.autostart||!1,this.results=t.results||null,this.pending=0,this.session=0,this.running=!1,this.jobs=[],this.timers={}}function s(t){this.session++,this.running=!1,this.emit("end",t)}t.exports=o,i(t.exports.default=o,r),["pop","shift","indexOf","lastIndexOf"].forEach(function(t){o.prototype[t]=function(){return Array.prototype[t].apply(this.jobs,arguments)}}),o.prototype.slice=function(t,e){return this.jobs=this.jobs.slice(t,e),this},o.prototype.reverse=function(){return this.jobs.reverse(),this},["push","unshift","splice"].forEach(function(t){o.prototype[t]=function(){var e=Array.prototype[t].apply(this.jobs,arguments);return this.autostart&&this.start(),e}}),Object.defineProperty(o.prototype,"length",{get:function(){return this.pending+this.jobs.length}}),o.prototype.start=function(t){if(t&&function(t){var e=this;function n(t){e.end(t)}this.on("error",n),this.on("end",function i(r){e.removeListener("error",n),e.removeListener("end",i),t(r,this.results)})}.call(this,t),this.running=!0,!(this.pending>=this.concurrency))if(0!==this.jobs.length){var e=this,n=this.jobs.shift(),i=!0,r=this.session,o=null,a=!1,u=null,c=n.timeout||this.timeout;c&&(o=setTimeout(function(){a=!0,0<e.listeners("timeout").length?e.emit("timeout",h,n):h()},c),this.timers[o]=o),this.results&&(u=this.results.length,this.results[u]=null),this.pending++,e.emit("start",n);var f=n(h);f&&f.then&&"function"==typeof f.then&&f.then(function(t){return h(null,t)}).catch(function(t){return h(t||!0)}),this.running&&0<this.jobs.length&&this.start()}else 0===this.pending&&s.call(this);function h(t,c){i&&e.session===r&&(i=!1,e.pending--,null!==o&&(delete e.timers[o],clearTimeout(o)),t?e.emit("error",t,n):!1===a&&(null!==u&&(e.results[u]=Array.prototype.slice.call(arguments,1)),e.emit("success",c,n)),e.session===r&&(0===e.pending&&0===e.jobs.length?s.call(e):e.running&&e.start()))}},o.prototype.stop=function(){this.running=!1},o.prototype.end=function(t){(function(){for(var t in this.timers){var e=this.timers[t];delete this.timers[t],clearTimeout(e)}}).call(this),this.jobs.length=0,this.pending=0,s.call(this,t)}},function(t,e){"function"==typeof Object.create?t.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(t,e){function n(){}t.super_=e,n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}},function(t,e,n){"use strict";var i,r="object"==typeof Reflect?Reflect:null,o=r&&"function"==typeof r.apply?r.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};i=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var s=Number.isNaN||function(t){return t!=t};function a(){a.init.call(this)}((t.exports=a).EventEmitter=a).prototype.it=void 0,a.prototype.Si=0,a.prototype.ji=void 0;var u=10;function c(t){return void 0===t.ji?a.defaultMaxListeners:t.ji}function f(t,e,n,i){var r,o,s;if("function"!=typeof n)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n);if(void 0===(o=t.it)?(o=t.it=Object.create(null),t.Si=0):(void 0!==o.newListener&&(t.emit("newListener",e,n.listener?n.listener:n),o=t.it),s=o[e]),void 0===s)s=o[e]=n,++t.Si;else if("function"==typeof s?s=o[e]=i?[n,s]:[s,n]:i?s.unshift(n):s.push(n),0<(r=c(t))&&s.length>r&&!s.warned){s.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=t,a.type=e,a.count=s.length,function(t){console&&console.warn&&console.warn(t)}(a)}return t}function h(t,e,n){var i={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},r=function(){for(var t=[],e=0;e<arguments.length;e++)t.push(arguments[e]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,o(this.listener,this.target,t))}.bind(i);return r.listener=n,i.wrapFn=r}function l(t,e,n){var i=t.it;if(void 0===i)return[];var r=i[e];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(r):d(r,r.length)}function p(t){var e=this.it;if(void 0!==e){var n=e[t];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function d(t,e){for(var n=new Array(e),i=0;i<e;++i)n[i]=t[i];return n}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(t){if("number"!=typeof t||t<0||s(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");u=t}}),a.init=function(){void 0!==this.it&&this.it!==Object.getPrototypeOf(this).it||(this.it=Object.create(null),this.Si=0),this.ji=this.ji||void 0},a.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||s(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this.ji=t,this},a.prototype.getMaxListeners=function(){return c(this)},a.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var i="error"===t,r=this.it;if(void 0!==r)i=i&&void 0===r.error;else if(!i)return!1;if(i){var s;if(0<e.length&&(s=e[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var u=r[t];if(void 0===u)return!1;if("function"==typeof u)o(u,this,e);else{var c=u.length,f=d(u,c);for(n=0;n<c;++n)o(f[n],this,e)}return!0},a.prototype.on=a.prototype.addListener=function(t,e){return f(this,t,e,!1)},a.prototype.prependListener=function(t,e){return f(this,t,e,!0)},a.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e);return this.on(t,h(this,t,e)),this},a.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e);return this.prependListener(t,h(this,t,e)),this},a.prototype.off=a.prototype.removeListener=function(t,e){var n,i,r,o,s;if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e);if(void 0===(i=this.it))return this;if(void 0===(n=i[t]))return this;if(n===e||n.listener===e)0==--this.Si?this.it=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(r=-1,o=n.length-1;0<=o;o--)if(n[o]===e||n[o].listener===e){s=n[o].listener,r=o;break}if(r<0)return this;0===r?n.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(n,r),1===n.length&&(i[t]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",t,s||e)}return this},a.prototype.removeAllListeners=function(t){var e,n,i;if(void 0===(n=this.it))return this;if(void 0===n.removeListener)return 0===arguments.length?(this.it=Object.create(null),this.Si=0):void 0!==n[t]&&(0==--this.Si?this.it=Object.create(null):delete n[t]),this;if(0===arguments.length){var r,o=Object.keys(n);for(i=0;i<o.length;++i)"removeListener"!==(r=o[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this.it=Object.create(null),this.Si=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(i=e.length-1;0<=i;i--)this.removeListener(t,e[i]);return this},a.prototype.listeners=function(t){return l(this,t,!0)},a.prototype.rawListeners=function(t){return l(this,t,!1)},a.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):p.call(t,e)},a.prototype.listenerCount=p,a.prototype.eventNames=function(){return 0<this.Si?i(this.it):[]}},function(t,e,n){var i=this&&this.W||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};Object.defineProperty(e,"e",{value:!0});var r=n(0),o=["_hist","_hist_ptr","_id"],s=(a.prototype.willConnect=function(t,e){var n=this;this.parent=t.parent;var s={};Object.keys(t.models).forEach(function(e){if(0!==e.indexOf("_")){var i=r.u(t.models[e]).map(function(t){return t.props&&r.intersect(["pk","pk()"],t.props)&&(n.Ei[e]=t.key,n.ki[e]=t.type,n.Ni[e]={}),delete t.props,delete t.default,t});i.unshift({key:"_id",type:"timeIdms",props:["pk()"]}),s["_"+e+"__hist_rows"]=i,s["_"+e+"__hist_idx"]=[{key:"id",type:n.ki[e],props:["pk()"]},{key:"histRows",type:"timeIdms[]"},{key:"histPtr",type:"number"}]}});var a="string"!=typeof this.historyModeArgs,u=[{key:"id",type:"timeIdms",props:["pk()"]},{key:"table",type:"string"},{key:"keys",type:"any[]"}],c=[{key:"id",type:"timeIdms",props:["pk()"]},{key:"ptr",type:"int"}];"database"!==this.historyModeArgs&&this.historyModeArgs?"database"===this.historyModeArgs&&!a||(this.historyModes={},a?this.historyModes=r.u(this.historyModeArgs):Object.keys(this.Ei).forEach(function(t){n.historyModes[t]=n.historyModeArgs}),Object.keys(this.historyModes).forEach(function(t){"table"===n.historyModes[t]&&(s["_"+t+"__hist"]=u,s["_"+t+"__hist_ptr"]=c)})):(s[o[0]]=u,s[o[1]]=c),t.models=i({},t.models,s),e(t)},a.prototype.Ti=function(t){return t?this.historyModes?"table"===this.historyModes[t]?"_"+t+"__hist":null:"_hist":"__null"},a.prototype.Ii=function(t,e){var n=this,i=this.Ti(t);i?this.parent.query("select").manualExec({table:i+"_ptr"}).then(function(o){o.length?e():n.parent.query("upsert",{id:r.timeid(!0),table:t,ptr:0}).manualExec({table:i+"_ptr"}).then(e)}):e()},a.prototype.didConnect=function(t,e){function n(){r.fastALL(Object.keys(i.Ni),function(t,e,n){i.parent.extend("beforeConn","idx","_"+t+"__hist_idx").then(function(e){e.forEach(function(e){i.Ni[t][e]=!0}),i.historyModes?i.Ii(t,n):n()})}).then(e)}var i=this;this.historyModes?n():this.parent.query("select").manualExec({table:"_hist_ptr"}).then(function(t){t.length?n():i.parent.query("upsert",{id:r.timeid(!0),table:"",ptr:0}).manualExec({table:"_hist_ptr"}).then(n)})},a.prototype.Ai=function(t,e,n,i){var o=this,s="_"+t+"__hist_rows",a="_"+t+"__hist_idx";r.fastALL(e,function(e,n,u){o.parent.query("select").where(["id","=",e]).manualExec({table:a}).then(function(n){if(n.length){var c=Object.isFrozen(n[0])?r.u(n[0]):n[0],f=[];if(i)f=f.concat(c.histRows.filter(function(t){return-1!==t})),c.histPtr=0,c.histRows=[];else{for(;c.histPtr--;)f.push(c.histRows.shift());c.histPtr=0}f.length?o.parent.query("upsert",c).comment("History Purge").where(["id","=",e]).manualExec({table:a}).then(function(){o.parent.query("delete").comment("History Purge").where(["_id","IN",f]).manualExec({table:s}).then(function(){i?o.parent.query("select").where([o.Ei[t],"=",e]).manualExec({table:t}).then(function(n){o.Mi(t,["change"],e,n[0],!1,u)}):u()})}):u()}else u()})}).then(n)},a.prototype.xi=function(t,e,n){var i=this;this.parent.query("select").manualExec({table:t+"_ptr"}).then(function(o){var s=Object.isFrozen(o[0])?r.u(o[0]):o[0];if(n||0<s.ptr){var a=i.parent.query("select");n||a.range(-1*s.ptr,0),a.manualExec({table:t}).then(function(o){if(o.length){var a={};o.forEach(function(t){a[t.table]||(a[t.table]=[]),a[t.table]=a[t.table].concat(t.keys)}),r.fastALL(Object.keys(a),function(t,e,r){i.Ai(t,a[t],r,n)}).then(function(){i.parent.query("delete").comment("History Purge").where(["id","IN",o.map(function(t){return t.id})]).manualExec({table:t}).then(function(){s.ptr=0,i.parent.query("upsert",s).comment("History Purge").where(["id","=",s.id]).manualExec({table:t+"_ptr"}).then(e)})})}else e()})}else e()})},a.prototype.Ri=function(t,e,n){if(this.historyModes){var i=this.Ti(t);i?this.xi(i,n):this.Ai(t,e,n)}else this.xi("_hist",n)},a.prototype.Li=function(t,e,n){if(this.historyModes){var i=this.Ti(t);i?this.xi(i,n,!0):this.Ai(t,[e],n,!0)}else this.xi("_hist",n,!0)},a.prototype.didExec=function(t,e){var n=this;t.table&&0!==t.table.indexOf("_")&&-1<t.types.indexOf("change")&&-1===t.query.comments.indexOf("History Write")?this.Ri(t.table,t.affectedRowPKS,function(){r.fastALL(t.affectedRows,function(e,i,r){var o=e[n.Ei[t.table]];n.Ni[t.table][o]?n.Mi(t.table,t.types,o,e,!1,function(t){r(o)}):(n.Ni[t.table][o]=!0,n.Mi(t.table,t.types,o,e,!0,function(e){n.parent.query("upsert",{id:o,histRows:[e,-1],histPtr:0}).manualExec({table:"_"+t.table+"__hist_idx"}).then(function(){r(o)})}))}).then(function(i){n.Pi(t,i,e)})}):e(t)},a.prototype.Pi=function(t,e,n){var i=this.Ti(t.table);i?this.parent.query("upsert",{id:r.timeid(!0),table:t.table,keys:e}).manualExec({table:i}).then(function(){n(t)}):n(t)},a.prototype.Mi=function(t,e,n,s,a,u){function c(t){h.parent.query("select").where(["id","=",n]).manualExec({table:l}).then(function(e){var i=Object.isFrozen(e[0])||Object.isFrozen(e[0].histRows)?r.u(e[0]):e[0];i.histRows.unshift(t),h.parent.query("upsert",i).where(["id","=",n]).manualExec({table:l}).then(function(){u(t)})})}var f,h=this,l="_"+t+"__hist_idx",p=r.timeid(!0);-1<e.indexOf("delete")||-1<e.indexOf("drop")?c(-1):this.parent.query("upsert",i(((f={})[o[2]]=p,f),s)).manualExec({table:"_"+t+"__hist_rows"}).then(function(){a?u(p):c(p)})},a.prototype.extend=function(t,e,n){if("hist"===e[0]){var i=e[1],r=e[2],o=e[3];switch(i){case"<":case">":this.Di(i,r,o,function(n){t(e,[n])});break;case"?":this.Ci(r,o,function(n){t(e,n)});break;case"rev":this.Fi(r,o,function(n){t(e,n)});break;case"clear":this.Li(r,o,function(){t(e,n)})}}else t(e,n)},a.prototype.Fi=function(t,e,n){var i=this,s="_"+t+"__hist_idx";this.parent.query("select").where(["id","=",e]).manualExec({table:s}).then(function(e){var s=e[0].histRows.filter(function(t){return-1!==t});i.parent.query("select").where(["_id","IN",s]).manualExec({table:"_"+t+"__hist_rows"}).then(function(t){var i={};t.forEach(function(t){i[t[o[2]]]=Object.isFrozen(t)?r.u(t):t,delete i[t[o[2]]][o[2]]}),n([{pointer:e[0].histRows.length-e[0].histPtr-1,revisions:e[0].histRows.reverse().map(function(t){return-1===t?null:i[t]})}])})})},a.prototype.Ji=function(t,e){var n=this;this.parent.extend("idx.length",t).then(function(i){n.parent.query("select").manualExec({table:t+"_ptr"}).then(function(t){t.length?e([i,i-t[0].ptr]):e([0,0])})})},a.prototype.Ci=function(t,e,n){if(this.historyModes){var i=this.Ti(t);if(i){if(!t)throw Error("nSQL: Need a table to query this history!");this.Ji(i,n)}else{if(!e)throw Error("nSQL: Need a row primary key to query this history!");var r="_"+t+"__hist_idx";this.parent.query("select").where(["id","=",e]).manualExec({table:r}).then(function(t){var e=t[0];n([e.histRows.length,e.histRows.length-e.histPtr-1])})}}else this.Ji("_hist",function(t){n(t)})},a.prototype.qi=function(t,e,n){var i=this;this.parent.query("select").manualExec({table:e+"_ptr"}).then(function(o){var s=r.u(o[0]);s.ptr+="<"===t?1:-1,s.ptr<0&&(s.ptr=0),i.parent.extend("idx.length",e).then(function(a){s.ptr>a&&(s.ptr=a),o[0].ptr!==s.ptr?i.parent.query("select").range(-1,"<"===t?o[0].ptr:s.ptr).manualExec({table:e}).then(function(o){i.parent.query("upsert",s).manualExec({table:e+"_ptr"}).then(function(){r.fastALL(o[0].keys,function(e,n,r){i.Qi(t,o[0].table,e,r)}).then(function(t){n(-1<t.indexOf(!0))})})}):n(!1)})})},a.prototype.Qi=function(t,e,n,i){function o(t){s.parent.query("upsert",t).where([s.Ei[e],"=",n]).manualExec({table:"_"+e+"__hist_idx"}).then(function(){i(!0)})}var s=this;this.parent.query("select").where([this.Ei[e],"=",n]).manualExec({table:"_"+e+"__hist_idx"}).then(function(a){var u=r.u(a[0]);if(u.histPtr+="<"===t?1:-1,u.histPtr<0&&(u.histPtr=0),u.histPtr>u.histRows.length-1&&(u.histPtr=u.histRows.length-1),u.histPtr!==a[0].histPtr){var c=u.histRows[u.histPtr];-1===c?s.parent.query("delete").comment("History Write").where([s.Ei[e],"=",n]).manualExec({table:e}).then(function(){o(u)}):s.parent.query("select").where(["_id","=",c]).manualExec({table:"_"+e+"__hist_rows"}).then(function(t){s.parent.query("upsert",t[0]).comment("History Write").manualExec({table:e}).then(function(){o(u)})})}else i(!1)})},a.prototype.Di=function(t,e,n,i){if(this.historyModes){var r=this.Ti(e);if(r){if(!e)throw Error("nSQL: Need a table to change this history!");this.qi(t,r,i)}else{if(!n)throw Error("nSQL: Need a row primary key to change this history!");this.Qi(t,e,n,i)}}else this.qi(t,"_hist",i)},a);function a(t){this.historyModeArgs=t,this.Ei={},this.ki={},this.Ni={}}e.Z=s},function(t,e,n){Object.defineProperty(e,"e",{value:!0});var i=n(1),r=(o.prototype.debounce=function(t){return this.Y[this.Hi.length]=t,this.Hi.push("dbnc"),this},o.prototype.distinct=function(t,e){return this.Y[this.Hi.length]=[t||function(t){return t},e||function(t,e){return t===e}],this.Hi.push("dsct"),this},o.prototype.filter=function(t){return this.Y[this.Hi.length]=t,this.Hi.push("fltr"),this},o.prototype.map=function(t){return this.Y[this.Hi.length]=t,this.Hi.push("mp"),this},o.prototype.first=function(t){return this.Y[this.Hi.length]=t||function(t,e){return!0},this.Hi.push("fst"),this},o.prototype.skip=function(t){return this.Y[this.Hi.length]=t,this.Hi.push("skp"),this},o.prototype.take=function(t){return this.Y[this.Hi.length]=t,this.Hi.push("tk"),this},o.prototype.subscribe=function(t){var e,n=this,i={},r={},o={},a={};return new s(this.Wi,this.Et,{next:function(s,u){if(n.y++,!e){var c=0,f=function(){if(c===n.Hi.length)"function"==typeof t?t(s,u):t.next&&t.next(s,u),e&&t.complete&&t.complete(s,u);else{function h(t){if(0===n.y)return 0;for(var e=t,i=n.y,r=!1;e--&&!r;)void 0!==a[e]&&(r=!0,i=a[e]);return i}switch(n.Hi[c]){case"dbnc":if(r[c]){clearTimeout(o[c]);var l=n.Y[c];return void(o[c]=setTimeout(function(){Date.now()-r[c]>=l&&(r[c]=Date.now(),void 0===a[c]&&(a[c]=0),a[c]++,c++,f())},l-(Date.now()-r[c])))}r[c]=Date.now();break;case"dsct":var p=n.Y[c][0](s,u);if(!1!==n.Y[c][1](i[c],p))return;i[c]=p,void 0===a[c]&&(a[c]=0),a[c]++;break;case"fltr":if(!1===n.Y[c](s,h(c),u))return;void 0===a[c]&&(a[c]=0),a[c]++;break;case"fst":if(!0!==n.Y[c](s,h(c),u))return;void 0===a[c]&&(a[c]=0),a[c]++,e=!0;break;case"mp":s=n.Y[c](s,h(c),u);break;case"skp":if(h(c)<=n.Y[c])return;break;case"tk":h(c)>=n.Y[c]&&(e=!0)}c++,f()}};f()}},error:function(e){t.error&&t.error(e)}},this.$i)},o);function o(t,e,n){this.Wi=t,this.Et=e,this.$i=n,this.Hi=[],this.y=0,this.Y=[]}e.Observer=r;var s=(a.prototype.exec=function(t){var e=this;this.zi||i.setFast(function(){var n=e.Ki(t);n&&e.Wi.query("select").manualExec(n).then(function(n){e.Bi.next(n,t)}).catch(function(t){e.Bi.error(t)})})},a.prototype.unsubscribe=function(){var t=this;this.zi=!0,this.$i.forEach(function(e){t.Wi.table(e).off("change",t.exec)})},a.prototype.closed=function(){return this.zi},a);function a(t,e,n,i){var r=this;this.Wi=t,this.Ki=e,this.Bi=n,this.$i=i,this.zi=!1,this.exec=this.exec.bind(this),this.unsubscribe=this.unsubscribe.bind(this);var o=this.Ki();o&&(this.$i=this.$i.concat([o.table]),this.$i=this.$i.filter(function(t,e,n){return n.indexOf(t)===e}),this.exec()),this.$i.forEach(function(t){r.Wi.table(t).on("change",r.exec)})}e.ObserverSubscriber=s}],t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:i})},t.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"e",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.e)return e;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var r in e)t.d(i,r,function(t){return e[t]}.bind(null,r));return i},t.n=function(e){var n=e&&e.e?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},t.p="",t(t.s=11);function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var e,n});